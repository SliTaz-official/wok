# SliTaz package receipt.

PACKAGE="slitaz-boot-scripts"
VERSION="2.5.2"
CATEGORY="base-system"
SHORT_DESC="Provide all the initialisation scripts used at boot time."
MAINTAINER="pankso@slitaz.org"
TARBALL="$PACKAGE-$VERSION.tar.gz"
WEB_SITE="http://www.slitaz.org/"
WGET_URL="http://mirror.slitaz.org/sources/boot-scripts/$TARBALL"
CONFIG_FILES="/etc/inittab /etc/init.d/local.sh /etc/rcS.conf /etc/network.conf"

# Rules to gen a SliTaz package suitable for Tazpkg.
#
# This package is all build by genpkg, it provide the boot scripts found
# in /etc/init.d with the main config file : /etc/rcS.conf. It provide also
# the default inittab and the network config file used with network.sh
#
genpkg_rules()
{
	mkdir -p $fs/usr/share
	cp -a $src/etc $fs
	cp -a $src/applications $fs/usr/share

	# Perms
	chown -R root.root $fs/etc/init.d
	chmod 755 $fs/etc/init.d/*.sh
	chmod 755 $fs/etc/init.d/rc*
}

# Pre install commands.
#
pre_install()
{
 	local root
 	root=$1

	# Backup file to restore with post install
	echo "Creating backups of configs..."
	cp $root/etc/rcS.conf $root/etc/rcS.conf.bak 2>/dev/null
	cp $root/etc/network.conf $root/etc/network.conf.bak 2>/dev/null
	cp $root/etc/inittab $root/etc/inittab.bak 2>/dev/null
	cp $root/etc/init.d/local.sh $root/etc/init.d/local.sh.bak 2>/dev/null
}

post_install()
{
 	local root
 	root=$1
	( cd $1/ ; cpio -o -H newc | gzip -9 ) > \
		$1/$INSTALLED/$PACKAGE/volatile.cpio.gz <<EOT
etc/rcS.conf
etc/network.conf
EOT
	echo "Restoring configs backups..."
	mv -f $root/etc/rcS.conf.bak $root/etc/rcS.conf 2>/dev/null
	mv -f $root/etc/network.conf.bak $root/etc/network.conf 2>/dev/null
	mv -f $root/etc/inittab.bak $root/etc/inittab 2>/dev/null
	mv -f $root/etc/init.d/local.sh.bak $root/etc/init.d/local.sh 2>/dev/null

	# wifi config
	if ! grep -q ^WIFI $root/etc/network.conf; then
		cat >> $root/etc/network.conf << "EOT"
# Wifi connection.
# Enable/disable wireless connection at boot time.
WIFI="no"

# Wifi interface (iwconfig) and ESSID.
WIFI_INTERFACE="wlan0"
WIFI_ESSID="any"
WIFI_MODE="managed"
WIFI_KEY=""
WIFI_KEY_TYPE="none"
WPA_DRIVER=""
WIFI_CHANNEL=""
WIFI_IWCONFIG_ARGS=""
NDISWRAPPER_DRIVERS=""

EOT
	fi
	# From 2.3 default user have uid=1000 (standard), so change hacker
	# id/group and chown.
	if grep -q "500:500" $root/etc/passwd; then
		sed -i s/'500:500'/'1000:1000'/ $root/etc/passwd
		sed -i s/'500'/'1000'/ $root/etc/group
		chown -R 1000.1000 $root/home/hacker
	fi 
}

repack_cleanup()
{
	zcat $INSTALLED/$PACKAGE/volatile.cpio.gz | ( cd $1 ; cpio -id )
}
