# SliTaz package receipt.

PACKAGE="gcc"
VERSION="4.5.1"
CATEGORY="development"
SHORT_DESC="The the GNU Compiler Collection."
MAINTAINER="pankso@slitaz.org"
DEPENDS="libgomp gmp mpfr gcc-lib-base mpc-library elfutils"
BUILD_DEPENDS="glibc-dev gawk flex gmp gmp-dev mpfr mpfr-dev mpc-library \
elfutils elfutils-dev"
TARBALL="$PACKAGE-$VERSION.tar.bz2"
WEB_SITE="http://gcc.gnu.org/"
WGET_URL="ftp://gcc.gnu.org/pub/gcc/releases/gcc-$VERSION/$TARBALL"

# Rules to configure and make the package.
compile_rules()
{
	# Use libiberty.a from binutils.
	sed -i 's/install_to_$(INSTALL_DEST) //' \
		$PACKAGE-$VERSION/libiberty/Makefile.in || exit 1
    mkdir -p gcc-build && cd gcc-build
    ../$PACKAGE-$VERSION/configure --prefix=/usr --libexecdir=/usr/lib \
    --infodir=/usr/share/info --mandir=/usr/share/man --enable-nls \
    --enable-languages=c,c++,objc,fortran --enable-shared --with-system-zlib \
    --enable-clocale=gnu --enable-objc-gc --enable-__cxa_atexit --enable-lto \
    --enable-threads=posix --with-tune=i486 i486-pc-linux-gnu &&
    make -j 4 bootstrap &&
    # Make install in the source tree to help creating derivated pkgs
    # and keep $_pkg variable set for genpkg.
    make -j 4 DESTDIR=$src/_pkg install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p  $fs/usr/share
    cp -a $_pkg/usr/bin $fs/usr
    # Copy all libs. Remove libgcc_s.so and libstdc++.so
    # they goes in gcc-lib-base-$VERSION package.
    cp -a $_pkg/usr/lib $fs/usr
    rm $fs/usr/lib/libgcc_s.so*
    rm $fs/usr/lib/libstdc++.so*
    rm $fs/usr/lib/libgomp.so*
    # Include files.
    cp -a $_pkg/usr/include $fs/usr
    # Gfortran goes in gfortran-$VERSION package.
    rm -f $fs/usr/bin/*gfortran
    rm -f $fs/usr/lib/libgfortran*
    rm -f $fs/usr/lib/gcc/*/$VERSION/libgfortran*
    rm -rf $fs/usr/lib/gcc/*/$VERSION/f*
}

# Post install commands for Tazpkg.
post_install()
{
  local root
  root=$1
  echo "Processing post-install commands..."
  if [ ! -f "$root/lib/cpp" ]; then
  	ln -s ../usr/bin/cpp $root/lib
  fi
  if [ ! -f "$root/usr/bin/cc" ]; then
  	ln -s gcc $root/usr/bin/cc
  fi
}
