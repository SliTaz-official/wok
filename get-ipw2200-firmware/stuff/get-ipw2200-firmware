# install linux-wireless if needed.

MODULE=ipw2200
PKG=$MODULE-firmware
VERSION=3.0-9.0.1
SHORT_DESC="Intel PRO/Wireless 2200BG firmware."
WEB_SITE="http://$MODULE.sourceforge.net/"
RPM=$PKG-$VERSION.noarch.rpm
WGET_URL="http://dl.atrpms.net/all/$RPM"

# Check if user is root to install.
if test $(id -u) != 0 ; then
        echo -e "\nYou must be root to run `basename $0`."
	echo -e "Please use 'su' and root password to become super-user.\n"
	exit 0
fi

# Avoid reinstall
if [ -d /var/lib/tazpkg/installed/$PKG ]; then
	echo -e "\n$PKG package is already installed.\n"
	exit 0
fi

# We need drivers and tools.
for pkg in linux-wireless wireless_tools
do
        if [ ! -d /var/lib/tazpkg/installed/$pkg ]; then
		tazpkg get-install $pkg
	fi
done

# Get files
TMP=/tmp/$(basename $0)$$
mkdir $TMP
TOP=$PWD
cd $TMP
wget $WGET_URL
rpm2cpio < $RPM | cpio -id
	
# Create pseudo package
mkdir -p $PKG-$VERSION/fs/lib/firmware
rm -f lib/firmware/*LICENSE*
mv lib/firmware/* $PKG-$VERSION/fs/lib/firmware

# Creat receipt
cat > $PKG-$VERSION/receipt <<EOT
PACKAGE="$PKG"
VERSION="$VERSION"
CATEGORY="non-free"
SHORT_DESC="$SHORT_DESC."
WEB_SITE="$WEB_SITE"
EOT

# Pack
tazpkg pack $PKG-$VERSION

# Install pseudo package
tazpkg install $PKG-$VERSION.tazpkg

# Clean
cd $TOP
rm -rf $TMP

# Load module
echo "Loading module: $MODULE..."
modprobe $MODULE
sleep 1

# Configure /etc/network.conf and start connexion
sed -i s/'WIFI="no"'/'WIFI="yes"'/ /etc/network.conf
/etc/init.d/netwok.sh restart

