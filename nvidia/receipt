# SliTaz package receipt.

PACKAGE="nvidia"
VERSION="177.82"
CATEGORY="non-free"
SHORT_DESC="NVIDIA X.org kernel driver."
MAINTAINER="b1+slitaz@nagel.org"
DEPENDS="xorg xorg-server linux-agp"
TARBALL="NVIDIA-Linux-x86-$VERSION-pkg0.run"
WEB_SITE="http://www.nvidia.com"
_WGET_URL="http://us.download.nvidia.com/XFree86/Linux-x86/$VERSION/$TARBALL"

# Rules to configure and make the package.
compile_rules()
{
  if [ ! -d $WOK/linux/taz ]; then
    tazwok cook linux
  fi
  if [ ! -f "$SOURCES_REPOSITORY/$TARBALL" ]; then
    cd $SOURCES_REPOSITORY
    download $_WGET_URL
    if [ ! -f "$SOURCES_REPOSITORY/$TARBALL" ]; then
      echo -e "\nDownload failed, exiting. Please check WGET_URL variable.\n"
      exit 1
    fi
  else
    echo -n "Source tarball exit... "
    status
  fi
  if [ ! -d $src ]; then
    cd $WOK/$PACKAGE
    sh "$SOURCES_REPOSITORY/$TARBALL" --extract-only
    mv "NVIDIA-Linux-x86-$VERSION-pkg0" "$PACKAGE-$VERSION"
  fi
  cd $src/usr/src/nv
  [ ! -f Makefile ] && ln -s Makefile.kbuild Makefile
  make SYSSRC=$(ls -d $WOK/linux/linux-*/) module
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
  KERNEL_VERSION=$(grep "kernel version" ../linux/$(ls ../linux/taz)/.config)
  KERNEL_VERSION=${KERNEL_VERSION##* }-slitaz
  mkdir -p $fs/lib/modules/$KERNEL_VERSION/kernel/drivers/video
  install -m644 $src/usr/src/nv/nvidia.ko $fs/lib/modules/$KERNEL_VERSION/kernel/drivers/video/
  mkdir -p $fs/usr/share/doc/nvidia
  cp $src/LICENSE $fs/usr/share/doc/nvidia
}

# Post install/remove commands for Tazpkg.
post_install()
{
	chroot "$1/" depmod -a ${EXTRAVERSION#_}-slitaz
}

post_remove()
{
  depmod -a ${EXTRAVERSION#_}-slitaz
}
