# SliTaz package receipt.

PACKAGE="openldap"
VERSION="2.4.24"
CATEGORY="misc"
SHORT_DESC="LDAP database system."
MAINTAINER="pascal.bellard@slitaz.org"
TARBALL="$PACKAGE-$VERSION.tgz"
WEB_SITE="http://www.openldap.org/"
WGET_URL="ftp://ftp.openldap.org/pub/OpenLDAP/$PACKAGE-release/$TARBALL"
DEPENDS="libdb openssl libkrb5 libcomerr3 util-linux-ng-uuid icu \
gcc-lib-base libldap"
BUILD_DEPENDS="db-dev libdb libsasl-without-ldap"
CONFIG_FILES="/etc/openldap"
DATABASE_FILES="/var/openldap-*"

# Rules to configure and make the package.
compile_rules()
{

	cd $src
	./configure --prefix=/usr --infodir=/usr/share/info \
		--sysconfdir=/etc --localstatedir=/var \
		--libexecdir=/usr/lib/$PACKAGE \
		--mandir=/usr/share/man $CONFIGURE_ARGS
	which soelim || find -name Makefile | xargs sed -i 's/soelim/cat/'
	make -j 4 CPPFLAGS=-D_GNU_SOURCE &&
	make DESTDIR=$PWD/_pkg install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/lib $fs/etc/ldap.d
	cp -a $_pkg/etc $fs
	cp -a $_pkg/usr/bin $fs/usr
	cp -a $_pkg/usr/sbin $fs/usr
	cp -a $_pkg/usr/lib/$PACKAGE $fs/usr/lib
	strip -s $fs/usr/lib/$PACKAGE/*
	cp -a $_pkg/var $fs
	cp -a stuff/etc/init.d $fs/etc
	chmod 700 $fs/var/openldap-data $fs/etc/openldap
}

# Pre and post install commands for Tazpkg.
post_install()
{
	( cd $1/$INSTALLED/ ; grep -l /etc/openldap/slapd.conf */receipt ) | \
	while read file; do
		pkg=$(dirname $file)
		[ "$pkg" = "$PACKAGE" ] && continue
		echo "Reconfiguring $pkg for $PACKAGE..."
		chroot $1/ tazpkg reconfigure $pkg
	done
}
