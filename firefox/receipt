# SliTaz package receipt.

PACKAGE="firefox"
VERSION="3.0-rc3"
CATEGORY="network"
SHORT_DESC="User friendly, secure and fast web browser."
MAINTAINER="pankso@slitaz.org"
DEPENDS="gtk+ sqlite"
BUILD_DEPENDS="xorg-dev gtk+-dev zip libIDL coreutils findutils xorg-libXft-dev"
TARBALL="$PACKAGE-3.0rc3-source.tar.bz2"
WEB_SITE="http://www.mozilla.org/"
WGET_URL="ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/3.0rc3/source/$TARBALL"

# Rules to configure and make the package.
#
# A long compile time... dont forget to build libidl before and check the
# .mozconfig file from the stuff and the stuff/README document.
#
compile_rules()
{
	# Move the mozilla source tree to $PACKAGE-$VERSION to keep variables
	# and to have a nice clean.
	#
	mv mozilla $PACKAGE-$VERSION
	cp -a stuff/firefox.mozconfig $src/.mozconfig
	cd $src
	./configure $CONFIGURE_ARGS
	make
	make DESTDIR=$PWD/_pkg install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/lib $fs/usr/share $fs/etc
	cp -a $_pkg/usr/bin $fs/usr
	cp -a $_pkg/usr/lib/$PACKAGE-3.0 $fs/usr/lib

	# SliTaz Web site for the home page, bookmarks file and branding.
	cp -a stuff/browserconfig.properties $fs/usr/lib/$PACKAGE-3.0
	cp -a stuff/bookmarks.html $fs/usr/lib/$PACKAGE-3.0/defaults/profile
	cp -a stuff/firefox-branding.js \
		$fs/usr/lib/$PACKAGE-3.0/defaults/pref/

	# User preference.
	cp -a stuff/prefs.js $fs/usr/lib/$PACKAGE-3.0/defaults/profile
	cp -a stuff/userChrome.css \
		$fs/usr/lib/$PACKAGE-3.0/defaults/profile/chrome

	# Move default config to /etc/firefox (/usr maybe read-only)
	mv -f $fs/usr/lib/$PACKAGE-3.0/defaults $fs/etc/$PACKAGE
	ln -s /etc/$PACKAGE $fs/usr/lib/$PACKAGE-3.0/defaults
	# EULA is accepted by SliTaz project.
	sed -i s:'pref("browser.EULA.3.accepted", false);':'pref("browser.EULA.3.accepted", true);': \
		$fs/etc/firefox/pref/firefox.js

	# Locale fr
	tar xjf stuff/langpack-fr@firefox.mozilla.org.tar.bz2 \
	-C $fs/usr/lib/$PACKAGE-3.0/extensions

	# Search Plugin (by: oddball)
	cp -a stuff/searchplugins $fs/usr/lib/firefox-3.0/
	chown -R root.root $fs

	# Remove unnecessary files.
	#rm -f $fs/usr/lib/$PACKAGE-3.0/TestGtkEmbed
	rm -rf $fs/usr/lib/$PACKAGE-3.0/dictionaries/*
	rm -rf $fs/usr/lib/$PACKAGE-3.0/icons
	rm -rf $fs/usr/lib/$PACKAGE-3.0/libsqlite3.so
}

# Pre - Post install command to set default locale.
pre_install()
{
	local root
	root=$1
	# Remove old libs
	rm -rf $root/usr/lib/firefox-*
}
post_install()
{
	local root
	root=$1
	if grep -q "fr_*" $root/etc/locale.conf; then
		sed -i 's/en-US/fr/' \
		$root/etc/firefox/pref/firefox-l10n.js
	fi
}
