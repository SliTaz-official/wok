# SliTaz package receipt.

PACKAGE="firefox"
VERSION="2.0.0.11"
CATEGORY="extra"
SHORT_DESC="User friendly, secure and fast web browser."
MAINTAINER="pankso@slitaz.org"
DEPENDS="gtk+"
TARBALL="$PACKAGE-$VERSION-source.tar.bz2"
WEB_SITE="http://www.mozilla.org/"
WGET_URL="ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/$VERSION/source/$TARBALL"

# Rules to configure and make the package.
#
# A long compile time... dont forget to build libidl before and check the
# .mozconfig file from the stuff and the stuff/README document.
#
compile_rules()
{
	# Move the mozilla source tree to $PACKAGE-$VERSION to keep variables
	# and to have a nice clean.
	#
	mv mozilla $PACKAGE-$VERSION
	cp -a stuff/firefox.mozconfig $src/.mozconfig
	cd $src
	./configure $CONFIGURE_ARGS
	make
	make DESTDIR=$PWD/_pkg install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/lib $fs/usr/share/pixmaps $fs/etc
	cp -a $_pkg/usr/bin $fs/usr
	cp -a $_pkg/usr/lib/$PACKAGE-$VERSION $fs/usr/lib

	# SliTaz Web site for the home page and bookmarks file.
	cp -a stuff/browserconfig.properties $fs/usr/lib/$PACKAGE-$VERSION
	cp -a stuff/bookmarks.html $fs/usr/lib/$PACKAGE-$VERSION/defaults/profile

	# User preference.
	cp -a stuff/prefs.js $fs/usr/lib/$PACKAGE-$VERSION/defaults/profile
	cp -a stuff/userChrome.css \
		$fs/usr/lib/$PACKAGE-$VERSION/defaults/profile/chrome

	# Mozilla default pixmaps and Firefox icon from the stuff.
	cp -a stuff/mozicon.png $fs/usr/share/pixmaps
	rm -rf $fs/usr/lib/$PACKAGE-$VERSION/icons

	# Move default config to /etc/firefox (/usr maybe read-only)
	mv -f $fs/usr/lib/$PACKAGE-$VERSION/defaults $fs/etc/$PACKAGE
	ln -s /etc/$PACKAGE $fs/usr/lib/$PACKAGE-$VERSION/defaults

	# Strip
	strip -s $fs/usr/lib/$PACKAGE-$VERSION/* 2>/dev/null
	
	# Locale fr
	tar xjf stuff/langpack-fr@firefox.mozilla.org.tar.bz2 \
	-C $fs/usr/lib/$PACKAGE-$VERSION/extensions
	
	# Remove unnecessary files.
	rm -f $fs/usr/lib/$PACKAGE-$VERSION/TestGtkEmbed
}

# Pre - Post install command to set default locale.
pre_install()
{
	local root
	root=$1
	# Remove old libs
	rm -rf $root/usr/lib/firefox-*
}
post_install()
{
	local root
	root=$1
	if grep -q "fr_*" $root/etc/locale.conf; then
	sed -i 's/en-US/fr/' \
	$root/usr/lib/$PACKAGE-$VERSION/defaults/pref/firefox-l10n.js
	fi
}
