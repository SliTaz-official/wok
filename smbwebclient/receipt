# SliTaz package receipt.

PACKAGE="smbwebclient"
VERSION="2.9"
CATEGORY="network"
SHORT_DESC="Samba client over the Web."
MAINTAINER="pascal.bellard@slitaz.org"
WEB_SITE="http://$PACKAGE.sourceforge.net/"
DEPENDS="php smbclient"
CONFIG_FILES="/etc/samba/smbwebclient.conf"

# Rules to configure and make the package.
compile_rules()
{
	if [ ! -d $src ]; then
		mkdir -p $src
		wget $SF_MIRROR/$PACKAGE/$PACKAGE-$VERSION.php.gz
		mv $PACKAGE-$VERSION.php.gz $src
		gunzip $src/$PACKAGE-$VERSION.php.gz
	fi
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/share/samba $fs/etc/samba
	cp -a $src/. $fs/usr/share/samba
	cp -a stuff/* $fs
}

post_install()
{
	( cd $1/ ; cpio -o -H newc | gzip -9 ) > \
		$1/$INSTALLED/$PACKAGE/volatile.cpio.gz <<EOT
etc/samba/smbwebclient.conf
EOT
	if [ -f $1/etc/locale.conf ]; then
		lang=$(. /etc/locale.conf; echo ${LANG%_*})
		sed -i "s/DefaultLanguage = 'us'/DefaultLanguage = '$lang'/" \
			$1/etc/samba/smbwebclient.conf
	fi
	
	if [ -f $1/etc/lighttpd/lighttpd.conf ]; then
		if ! grep -q /usr/share/samba/ $1/etc/lighttpd/lighttpd.conf; then
	    		sed -e 's|.*"/examples/" => "/usr/share/examples/",|    "/examples/" => "/usr/share/examples/",\n    "/smbwebclient/" => "/usr/share/samba/",|g' -i $1/etc/lighttpd/lighttpd.conf
			if [ -z "$1" ]; then
				# Start Web server.
				/etc/init.d/lighttpd stop
				/etc/init.d/lighttpd start
			fi
		fi
	fi
	# Configure apache server
	if [ -f $1/etc/apache/httpd.conf ]; then
		if [ ! -f $1/etc/apache/conf.d/smbwebclient ]; then
			cat > $1/etc/apache/conf.d/smbwebclient <<EOT
<IfModule mod_alias.c>
    Alias /smbwebclient /usr/share/samba
</IfModule>
<DirectoryMatch /usr/share/samba/>
    DirectoryIndex index.php
    Options +FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
</DirectoryMatch>
EOT
			if [ -z "$1" ]; then
				# Start Web server.
				/etc/init.d/apache restart
			fi
		fi
	fi
	cat <<EOF
---
Check \$cfgDefaultServer in configuration file /etc/samba/smbwebclient.conf 
---
EOF
}

repack_cleanup()
{
        zcat $INSTALLED/$PACKAGE/volatile.cpio.gz | ( cd $1 ; cpio -id )
}
