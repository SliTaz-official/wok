# SliTaz package receipt.

PACKAGE="cross-arm-glibc"
VERSION="2.14.1"
CATEGORY="system-tools"
SHORT_DESC="The GNU C libraries for the ARM cross toolchain"
MAINTAINER="pankso@slitaz.org"
SOURCE="glibc"
TARBALL="$SOURCE-$VERSION.tar.gz"
WEB_SITE="http://www.gnu.org/software/libc/"
WGET_URL="$GNU_MIRROR/$PACKAGE/$TARBALL"

DEPENDS=""
BUILD_DEPENDS="linux-arm-api-headers cross-arm-binutils cross-arm-gcc \
autoconf bash gawk"

# Cross toolchain variables.
CROSS_TARGET="arm-slitaz-linux-gnueabi"
CROSS_PREFIX="/usr/cross/arm"
CROSS_TRIPLET="--build=$HOST_SYSTEM --host=$HOST_SYSTEM --target=$CROSS_TARGET"

# CFLAGS and CXXFLAGS must not be set during the building of cross-tools.
unset CFLAGS CXXFLAGS CONFIG_SITE

# Path to cross tools
export PATH=$PATH:$CROSS_PREFIX/bin

# Rules to configure and make the package.
compile_rules()
{
	echo "cook: make linux/version.h"
	cd $CROSS_PREFIX/include
	make linux/version.h

	cd $src

	# Glibc ports.
	if [ ! -f "$SRC/glibc-ports-$VERSION.tar.bz2" ]; then
		wget $GNU_MIRROR/$SOURCE/glibc-ports-$VERSION.tar.bz2 \
			-O $SRC/glibc-ports-$VERSION.tar.bz2
	fi
	echo "Extracting glibc-ports..."
	tar xjf $SRC/glibc-ports-$VERSION.tar.bz2
	mv glibc-ports-$VERSION ports

	# #define TLS_DTV_UNALLOCATED ((void *) -1l) is already in dl-tls.h
	#echo "#define TLS_DTV_UNALLOCATED ((void *) -1l)" \
	#	>> ports/sysdeps/arm/dl-tls.h

	mkdir ../glibc-build && cd ../glibc-build
	CC=$CROSS_PREFIX/bin/$CROSS_TARGET-gcc
	echo "libc_cv_forced_unwind=yes" > config.cache
	echo "libc_cv_c_cleanup=yes" >> config.cache
	$src/configure \
		--prefix=$CROSS_PREFIX \
		--enable-add-ons \
		--with-headers=$CROSS_PREFIX/include \
		--with-binutils=$CROSS_PREFIX/bin \
		--config-cache \
		--build=$HOST_SYSTEM \
		--host=$CROSS_TARGET &&
	make && make install_root=$DESTDIR install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr
	cp -a $install/usr/cross $fs/usr
	#cd ${fs}${CROSS_PREFIX}/$CROSS_TARGET
	#rm -rf lib include
	#ln -s ../lib lib
	#ln -s ../include include
}
