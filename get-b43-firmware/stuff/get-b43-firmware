#!/bin/sh
#
# Get and install non-free Broadcom b43 firmware. The script wil also
# install linux-wireless and b43-fwcutter if needed. Finaly try to
# configure wlan0 interface.
#

DIR="broadcom-wl"
VERSION=4.80.53.0
TARBALL=$DIR-$VERSION.tar.bz2
WGET_URL="http://downloads.openwrt.org/sources/$TARBALL"

# Check if user is root to install.
if test $(id -u) != 0 ; then
	echo -e "\nYou must be root to run `basename $0`."
	echo -e "Please use 'su' and root password to become super-user.\n"
	exit 0
fi

# Avoid reinstall
if [ -d /var/lib/tazpkg/installed/b43-firmware ]; then
	echo -e "\nb43-firmware package is already installed.\n"
	exit 0
fi

# We need drivers, the extractor and tools.
for pkg in linux-wireless b43-fwcutter wireless_tools
do
	if [ ! -d /var/lib/tazpkg/installed/$pkg ]; then
		tazpkg get-install $pkg
	fi
done

# Get files
cd /tmp
wget $WGET_URL
tar xjf $TARBALL
cd $DIR-$VERSION/kmod

# Create pseudo package
mkdir -p b43-firmware-$VERSION/fs/lib/firmware
b43-fwcutter -w "b43-firmware-$VERSION/fs/lib/firmware" wl_apsta.o

# Creat receipt
cat > b43-firmware-$VERSION/receipt <<EOT
PACKAGE="b43-firmware"
VERSION="$VERSION"
CATEGORY="non-free"
SHORT_DESC="Broadcom b43 firmware."
DEPENDS="b43-fwcutter"
WEB_SITE="http://downloads.openwrt.org/"
EOT

# Pack
tazpkg pack b43-firmware-$VERSION

# Install pseudo package
tazpkg install b43-firmware-$VERSION.tazpkg

# Clean
cd /tmp
rm -rf $TARBALL $DIR-$VERSION

# Load b43 module
echo "Loading module: b43..."
modprobe b43
sleep 1

# Configure /etc/network.conf and start connexion
sed -i s/'WIFI="no"'/'WIFI="yes"'/ /etc/network.conf
. /etc/network.conf

iwconfig $WIFI_INTERFACE essid $ESSID
echo "Starting udhcpc client on: $WIFI_INTERFACE... "
/sbin/udhcpc -b -i $WIFI_INTERFACE \
	-p /var/run/udhcpc.$WIFI_INTERFACE.pid

