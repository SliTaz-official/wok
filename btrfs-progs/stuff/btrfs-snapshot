#!/bin/sh

# Keep last 30 daily snapshots with crontab
# Note: do not create 2 snapshots simultaneously (break btrfs mountage)
#0 * * * * /usr/bin/btrfs-snapshot 5  -hourly
#1 0 * * * /usr/bin/btrfs-snapshot 30 -daily
#2 0 1 * * /usr/bin/btrfs-snapshot 12 -monthly
#3 0 1 1 * /usr/bin/btrfs-snapshot 99 -yearly

btrfs_list()
{
	awk '/ btrfs / { if (fs[$1] == "") { fs[$1] = $2; print $2 }}' \
		< /proc/mounts
}

which btrfs > /dev/null && for root in $(btrfs_list) ; do
	dir=${root%/}/.snapshots$2
	[ -d $dir ] || mkdir $dir
	cd $dir
	i=0
	for s in $(ls -r); do
		[ $((i++)) -ge ${1:-10} ] && btrfs subvolume delete $s
	done
	btrfs subvolume snapshot -r / $(date +%Y%m%d%H%M%S)
done
