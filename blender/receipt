# SliTaz package receipt.

PACKAGE="blender"
VERSION="2.75a"
CATEGORY="graphics"
TAGS="3D creator editor"
SHORT_DESC="3D content creation suite."
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL"
WEB_SITE="https://www.blender.org/"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="http://download.blender.org/source/$TARBALL"

SUGGESTED="nvidia"
DEPENDS="py3k mesa libsdl libsamplerate libdrm jpeg libglu-mesa openjpeg \
	ffmpeg lcms openexr desktop-file-utils libgomp tiff libpng freeglut \
	freetype openal zlib librsvg glew libboost-filesystem libboost-regex \
	libboost-thread libboost-date-time libboost-dev"
BUILD_DEPENDS="cmake xorg-libXmu ilmbase-dev yasm pkg-config coreutils-file-format \
	gettext mesa-dev freeglut-dev librsvg-dev openexr-dev tiff-dev openal-dev \
	libglu-mesa libsdl-dev py3k-dev libsamplerate-dev ffmpeg-dev lcms-dev openjpeg-dev \
	libboost-dev libboost-math-dev libboost-tr1-dev libboost-filesystem-dev \
	libboost-regex-dev libboost-thread-dev \
	libglu-mesa-dev glew-dev"

# Rules to configure and make the package.
compile_rules()
{
	sed -i 's|uname -m|echo i486|' GNUmakefile
	sed -i -e 's|\(PyModule_GetFilename\)(mod|_PyUnicode_AsString(\1Object(mod)|' \
		-e 's|(.*_Py_atomic_load_relaxed(.*t)|(PyThreadState_GetDict(|' \
			$src/source/blender/python/generic/py_capi_utils.c
	sed -i 's|char. chars = _PyUnicode_AsString|const &|' \
		$src/source/gameengine/Ketsji/KX_FontObject.cpp
	mkdir -p $WOK/$PACKAGE/source/build
	cd $WOK/$PACKAGE/source/build
	PY3K_VER=$(ls -d /usr/include/python3.?m | sed 's|.*python\(.*\)m|\1|')
	cmake $src						\
		-DCMAKE_INSTALL_PREFIX:PATH=/usr		\
		-DCMAKE_BUILD_TYPE:STRING=Release		\
		-DWITH_INSTALL_PORTABLE:BOOL=OFF		\
		-DWITH_PYTHON_INSTALL:BOOL=OFF			\
		-DWITH_OPENCOLLADA:BOOL=OFF			\
		-DWITH_GAMEENGINE:BOOL=ON			\
		-DWITH_CYCLES:BOOL=OFF				\
		-DWITH_PLAYER:BOOL=ON				\
		-DPYTHON_VERSION:STRING=$PY3K_VER		\
		-DPYTHON_LIBPATH:STRING=/usr/lib		\
		-DPYTHON_LIBRARY:STRING=python${PY3K_VER}m	\
		-DPYTHON_INCLUDE_DIRS:STRING=/usr/include/python${PY3K_VER}m
	# build
	make $MAKEFLAGS &&
	make DESTDIR=$DESTDIR install &&
	python3 -m compileall "$DESTDIR/usr/share/blender"
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	LOCALE="fr de pt_BR es zh_CN"

	mkdir -p $fs/usr/bin
	mkdir -p $fs/usr/share/pixmaps

	cp -a $install/usr/share/blender	$fs/usr/share
	cp -a $install/usr/bin			$fs/usr
	cp -a $install/usr/share/applications	$fs/usr/share
	cp -a $install/usr/share/icons		$fs/usr/share
	mv -f $fs/usr/bin/blender		$fs/usr/bin/blender-bin
	cp -a $stuff/blender			$fs/usr/bin
}
