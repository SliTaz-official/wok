# SliTaz package receipt.

PACKAGE="syslinux"
VERSION="4.06"
CATEGORY="base-system"
SHORT_DESC="LiveCD ISO bootloader (isolinux)"
MAINTAINER="pankso@slitaz.org"
TARBALL="$PACKAGE-$VERSION.tar.xz"
WEB_SITE="http://syslinux.zytor.com/"
WGET_URL="ftp://ftp.kernel.org/pub/linux/utils/boot/syslinux/$TARBALL"
BUILD_DEPENDS="kbd-base perl nasm dev86 lzma"
DEPENDS="gpxe memtest"
CONFIG_FILES="/boot/isolinux"

# Rules to gen a SliTaz package suitable for Tazpkg.
compile_rules()
{
    cd $src
    #patch -p 0 < $stuff/extra/iso9660.u
    patch -p 0 < $stuff/extra/readconfig.u
    cp -a $stuff/iso2exe .
    make -C iso2exe
    cp $stuff/tools/isohybrid.sh .
    cp $stuff/tools/keytab-lilo.pl .
    cp $stuff/extra/md5sum.c com32/modules
    grep -q md5sum.c32 com32/modules/Makefile ||
	sed -i 's/ifcpu64.c32/ifcpu64.c32 md5sum.c32/' com32/modules/Makefile
    make -C com32
    ./isohybrid.sh --build
    for i in /usr/share/kbd/keymaps/i386/*/*.map.gz; do
        [ "$(basename $(dirname $i))" = "include" ] && continue
        j=$(basename $i)
        j=${j%.map.gz}.kbd
        ./keytab-lilo.pl /usr/share/kbd/keymaps/i386/qwerty/us.map.gz $i > $j
    done
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
    mkdir -p $fs/boot/isolinux
    cp -a $src/core/isolinux.bin $fs/boot/isolinux
    cp -a $src/com32/modules/md5sum.c32 $fs/boot/isolinux/c32box.c32
    cp -a $src/com32/menu/vesamenu.c32 $fs/boot/isolinux
    # $stuff/isolinux.msg is the old way the have a splash image.
    cp $stuff/*.cfg $stuff/*.txt $stuff/help.* $stuff/opts.* $fs/boot/isolinux
    rm -f $fs/boot/isolinux/common.cfg $fs/boot/isolinux/default.cfg
    rm -f $fs/boot/isolinux/display.txt
    ( cd $src ; ls *.kbd | cpio -o -H newc ) > $fs/boot/isolinux/cpio.kbd
    while read label kbd loc menu; do
        for i in ${kbd/,/ }; do
	        [ -e $src/$i.kbd ] || continue
		cat >> $fs/boot/isolinux/i18n.cfg <<EOT

# ${kbd/,/.kbd or }.kbd keyboard
LABEL $label
	MENU LABEL $menu
	com32 c32box.c32
	append kbdmap cpio.kbd $i.kbd lang=$loc kmap=${kbd#*,}
EOT
		break
	done
    done <<EOT
br		br-abnt2	pt_BR	Brazil
cz		cz-lat2		C	Cesky
dk		dk-latin1	C	Dansk
de		de-latin1	de_DE	Deutsch
de_CH\ deCH	de_CH-latin1	de_DE	Deutsch Schweitz
sg		sg-latin1	de_DE	Deutsch Schweitz (sg)
nl		nl2		C	Dutch
en		uk		en_GB	English UK
us		us		en_US	English US
us_ac\ usac	us-acentos	en_US	English US (acentos)
us_dv\ usdv	dvorak		en_US	English US (dvorak)
us_dl\ usdl	dvorak-l	en_US	English US (dvorak-l)
us_dr\ usdr	dvorak-r	en_US	English US (dvorak-r)
es		es		es_ES	Espanol
fr		fr-latin1	fr_FR	Francais
be		be-latin1	fr_FR	Francais Belgique
ca		cf		fr_FR	Francais Canada
fr_CH\ frCH	fr_CH-latin1	fr_FR	Francais Suisse
cr		hr,croat	C	Hvratski
is		is-latin1	C	Islenska
it		it		it_IT	Italiano
jp		jp106		C	Japanese
hu		hu		C	Magyar
no		no-latin1	C	Norske
po		pl2		C	Polski
pt		pt-latin1	pt_PT	Portugues
ru		ru		ru_RU	Russian
sl		slovene		C	Slovenski
fi		fi-latin1	C	Suomi
se		se-lat6		C	Svenskt
tr		trq		C	Turk
tr2		tr_q-latin5	C	Turk latin5
EOT
    cat >> $fs/boot/isolinux/i18n.cfg <<EOT

LABEL exit
	MENU LABEL Back to main menu
MENU EXIT
MENU END
EOT
    sed -i 's/^LABEL us$/&\n	MENU DEFAULT/' $fs/boot/isolinux/i18n.cfg
    for kbd in $(cd $src ; ls *.kbd); do
    	[ -s $src/$kbd ] || echo "Invalid file $kbd"
    	grep -q " $kbd " $fs/boot/isolinux/i18n.cfg && continue
    	echo "Missing: file $kbd"
    done
    chown root.root $fs/boot/isolinux/*
}

# Pre and post install commands for Tazpkg.
post_install()
{
    sed -i "s/XXXXXXXX/$(date +%Y%m%d)/" $1/boot/isolinux/isolinux.cfg
}
