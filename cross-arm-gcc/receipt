# SliTaz package receipt.

PACKAGE="cross-arm-gcc"
VERSION="4.6.3"
CATEGORY="system-tools"
SHORT_DESC="Cross compiler for targeting ARM platform."
MAINTAINER="pankso@slitaz.org"
SOURCE="gcc"
WEB_SITE="http://gcc.gnu.org/"
TARBALL="$SOURCE-$VERSION.tar.bz2"
WGET_URL="$GNU_MIRROR/gcc/gcc-$VERSION/$TARBALL"

DEPENDS="mpc-library elfutils linux-arm-api-headers cross-arm-binutils"
BUILD_DEPENDS="linux-arm-api-headers cross-arm-binutils gmp gmp-dev \
mpfr mpfr-dev mpc-library elfutils-dev"

# Cross toolchain variables.
CROSS_TARGET="arm-slitaz-linux-gnueabi"
CROSS_PREFIX="/usr/cross/arm"
CROSS_TRIPLET="--build=$HOST_SYSTEM --host=$HOST_SYSTEM --target=$CROSS_TARGET"

# CFLAGS and CXXFLAGS must not be set during the building of cross-tools.
unset CFLAGS CXXFLAGS CONFIG_SITE

# Path to cross tools
export PATH=$PATH:$CROSS_PREFIX/bin

# Rules to configure and make the package.
compile_rules()
{
	cd $src

	# Package cross-arm-toolchain use 'cook --options' when rebuilding
	# the full SliTaz ARM cross toolchain.
	[ "$2" == "--first-pass" ] && opt=$2
	[ "$3" == "--first-pass" ] && opt=$3

	# Use libiberty.a from binutils.
	sed -i 's/install_to_$(INSTALL_DEST) //' libiberty/Makefile.in || return 1

	mkdir -p ../build && cd ../build

	case $opt in
		--first-pass)
			# Used by cross-arm-toolchain when rebuilding the full toolchain.
			echo "cook: configure GCC for: cross toolchain first pass"
			$src/configure \
				--prefix=$CROSS_PREFIX \
				--libexec=$CROSS_PREFIX/lib \
				--disable-shared \
				--enable-languages=c \
				--disable-threads \
				--disable-multilib \
				--disable-nls \
				--without-headers \
				--disable-libgomp \
				--disable-libmudflap \
				--disable-libssp \
				$CROSS_TRIPLET &&
			make all-gcc all-target-libgcc &&
			make install-gcc install-target-libgcc &&
			cd ${install}${CROSS_PREFIX}/lib/gcc/$CROSS_TARGET/$VERSION &&
			ln -s libgcc.a libgcc_eh.a ;;
		*)
			# Used to produce a full featured ARM GCC cross compiler.
			echo "cook: configure GCC for: final/full cross compiler"

			# We cant't have cross-arm-glibc it in DEPENDS since it not build
			# when we compile GCC --first-pass
			if [ ! "/var/lib/tazpkg/installed/cross-arm-glibc" ]; then
				tazpkg -i /home/slitaz/packages/cross-arm-glibc-2.14.1.tazpkg
			fi

			$src/configure \
				--prefix=$CROSS_PREFIX \
				--libexec=$CROSS_PREFIX/lib \
				--enable-shared \
				--enable-languages=c,c++ \
				--enable-c99 \
				--enable-long-long \
				--enable-__cxa_atexit \
				--enable-threads=posix \
				--with-pkgversion="SliTaz" \
				$CROSS_TRIPLET &&
			make && make install &&
			make all-target-libgcc &&
			make install-target-libgcc ;;
	esac

	# Some configure options we could use
	#--enable-multilib
	#--enable-addons
	#--with-newlib
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr
	cp -a $install/usr/cross $fs/usr
	rm -rf ${fs}${CROSS_PREFIX}/share

	# This will fix GCC final build since we dont use --with-sysroot=
	# Without that we go errors such as: cannot find crtn.o
	cd ${fs}${CROSS_PREFIX}/$CROSS_TARGET
	for dir in lib include; do
		mv -f $dir/* ../$dir 2>/dev/null
		rmdir $dir 2>/dev/null
		ln -s ../$dir .
	done
}
