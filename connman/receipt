# SliTaz package receipt.

PACKAGE="connman"
VERSION="1.12"
CATEGORY="network"
SHORT_DESC="Daemon for managing internet connections"
MAINTAINER="slaxemulator@gmail.com"
TARBALL="$PACKAGE-$VERSION.tar.xz"
WEB_SITE="http://connman.net/"
WGET_URL="http://linux-kernel.uio.no/pub/linux/network/$PACKAGE/$TARBALL"

DEPENDS="glib dbus iptables gnutls libnl udev wpa_supplicant"
BUILD_DEPENDS="glib-dev dbus-dev iptables iptables-dev gnutls-dev libnl-dev \
openconnect udev-dev wpa_supplicant readline-dev ncursesw-dev openvpn bluez-dev"

# Rules to configure and make the package.
compile_rules()
{
	# add dependency on libncurses.so,
	sed -i 's/-lreadline/-lreadline -lncurses/' Makefile.in
	cd $src
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--infodir=/usr/share/info \
		--mandir=/usr/share/man \
		--disable-gtk-doc \
		--disable-neard \
		--enable-threads \
		--enable-openconnect \
		--enable-vpnc \
		--enable-openvpn \
		--enable-polkit \
		--enable-client \
		$CONFIGURE_ARGS &&
	make && make DESTDIR=$DESTDIR install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	# dbus conf
	mkdir -p $fs/etc
	cp -a $install/etc/dbus-1 $fs/etc
	# conman exec
	mkdir -p $fs/usr
	cp -a $install/usr/sbin $fs/usr
	# libs
	mkdir -p $fs/usr/lib/connman/plugins-vpn
	cp -a $install/usr/lib/connman/plugins-vpn/*.so \
		$fs/usr/lib/connman/plugins-vpn
	# vpn scripts
	mkdir -p $fs/usr/lib/connman/scripts
	cp -a $install/usr/lib/connman/scripts $fs/usr/lib/connman
	# init script
	cp -a $stuff/etc $fs
}

# Pre and post remove commands for Tazpkg
post_install()
{
	local root=$1
	if ! grep -q ^CONNMAND_OPTIONS $root/etc/daemons.conf; then
		echo '# Connman daemon options.' >> $root/etc/daemons.conf
		echo 'CONNMAND_OPTIONS=""' >> $root/etc/daemons.conf
		echo '' >> $root/etc/daemons.conf
	fi
	if [ -z "$root" ]; then
		/etc/init.d/connmand start || continue
	fi
}

pre_remove()
{
	if [ -z "$1" ]; then
		/etc/init.d/connmand stop
	fi
}
