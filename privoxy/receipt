# SliTaz package receipt.

PACKAGE="privoxy"
VERSION="3.0.16-stable"
CATEGORY="network"
SHORT_DESC="Non-caching web privacy proxy."
MAINTAINER="paul@slitaz.org"
DEPENDS="zlib pcre"
BUILD_DEPENDS="zlib-dev autoconf perl m4 coreutils"
TARBALL="$PACKAGE-$VERSION-src.tar.gz"
WEB_SITE="http://www.privoxy.org/"
WGET_URL="http://downloads.sourceforge.net/ijbswa/$TARBALL"

# Rules to configure and make the package.
compile_rules()
{
	# Have to create privoxy user/group to be able to compile
	# adduser privoxy -s /bin/false -H -D -S
	
	cd $src

	# Needs autoconf
	autoheader
	autoconf

	./configure \
		--prefix=/usr \
		--sysconfdir=/etc/privoxy \
		--infodir=/usr/share/info \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--with-user=nobody \
		--with-group=nogroup \
		$CONFIGURE_ARGS &&
	make &&
	make DESTDIR=$PWD/_pkg install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/etc/init.d $fs/usr
	cp -a $_pkg/usr/sbin $fs/usr
	cp -a $_pkg/var $fs
	cp -a $_pkg/etc $fs

	# Copy daemon from /stuff
	cp stuff/daemon-privoxy $fs/etc/init.d/privoxy
}

post_install()
{
	# adduser privoxy if needed
	if ! grep -q privoxy $1/etc/passwd; then
		echo -n "Adding user privoxy..."
		chroot $1/ adduser privoxy -s /bin/false -H -D -S
		status
	fi
	
	# And change file permissions
	echo -n "Changing file permissions..."
	chown -R root.privoxy /etc/privoxy
	chown -R root.root /etc/privoxy/templates
	chown -R root.privoxy /var/log/privoxy
	status
}

# Del user privoxy when pkg is removed.
post_remove()
{
	deluser privoxy
}
