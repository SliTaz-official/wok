#!/bin/sh

sw=""
case "$(basename $0)" in
rootflags)	sw="-R" ;;
ramsize)	sw="-r" ;;
vidmode)	sw="-v" ;;
esac
[ -n "$sw" ] && set -- $sw "$@"

offset=508
image=
value=
format="Root device 0x%X"
while [ -n "$1" ]; do
	case "$1" in	
	-R)	offset=498; format="Root flags %d";;
	-r)	offset=504; format="Ramsize %d";;
	-v)	offset=506; format="Video mode%d";;
	-o)	offset=$(($2)); shift ;;
	*)	if [ -z "$image" ]; then
			image="$1"
		elif [ -z "$value" ]; then
			value="$1"
		else
			offset=$(($1))
		fi
	esac
	shift
done

if [ ! -s "$image" ]; then
	printf "0x%04X /\n" $(cat /proc/sys/kernel/real-root-dev)
elif [ -n "$value" ]; then
	for i in 1 2; do
		printf '\\\\x%02X' $(($value & 255))
		value=$(($value >> 8))
	done | xargs echo -en | \
	dd bs=1 conv=notrunc of=$image seek=$offset 2> /dev/null
else
	dd bs=1 conv=notrunc if=$image skip=$offset count=2 2> /dev/null | \
	hexdump -e '"" 1/2 "$format" "\n"'
fi
