#!/bin/sh

devname()
{
	d=$(find /dev -type b | while read b ; do
		[ "$(stat -c %02t%02T $b)" == "$1" ] && echo $b && break
	done)
	[ -n "$d" ] && echo $d || echo 0x$1
}

sw=""
case "$0" in
*rootflags)	sw="-R" ;;
*ramsize)	sw="-r" ;;
*vidmode)	sw="-v" ;;
esac
[ -n "$sw" ] && set -- $sw "$@"

ofs=508
img=
val=
fmt=
while [ -n "$1" ]; do
	case "$1" in	
	-R)	ofs=498; fmt="Root flags" ;;
	-r)	ofs=504; fmt="Ramsize" ;;
	-v)	ofs=506; fmt="Video mode" ;;
	-o)	ofs=$(($2)); shift ;;
	*-h*)	echo "Usage: rdev [-Rrvh] [-o offset] [kernel [data [offset]]]"
		exit 1 ;;
	*)	if [ -z "$img" ]; then
			img="$1"
		elif [ -z "$val" ]; then
			[ "${1:0:5}" == "/dev/" ] && val=0x$(stat -c %t%02T $1)
			val=$((${val:-$1}))
		else
			ofs=$(($1))
		fi
	esac
	shift
done

dd="dd bs=1 conv=notrunc count=2"
if [ ! -s "$img" ]; then
	echo $(devname $(stat -c %04D /)) /
elif [ -n "$val" ]; then
	for i in 1 2; do
		printf '\\\\x%02X' $(($val & 255))
		val=$(($val >> 8))
	done | xargs echo -en | $dd of=$img seek=$ofs
elif [ -n "$fmt" ]; then
	$dd if=$img skip=$ofs | hexdump -e "\"\" 1/2 \"$fmt %u\" \"\n\""
else
	echo -n "Root device "
	devname $($dd if=$img skip=$ofs | hexdump -e '"" 1/2 "%04X" "\n"')
fi 2>/dev/null
