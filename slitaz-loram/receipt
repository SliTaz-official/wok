# SliTaz package receipt.

PACKAGE="slitaz-loram"
VERSION="1.2"
CATEGORY="misc"
SHORT_DESC="Rules to build low ram rootfs.gz."
MAINTAINER="pascal.bellard@slitaz.org"
DEPENDS="cromfs"

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
    mkdir -p $fs/etc/tazlito
    cp stuff/loram.rootfs $fs/etc/tazlito
}

get_patch()
{
    cat <<EOF
--- /etc/init.d/rcS
+++ /etc/init.d/rcS
@@ -58,2 +58,14 @@
 
+# Mount compressed /usr
+if [ -f /.usr.cromfs ]; then
+	echo -n "Mounting compressed /usr read-only... "
+	if [ -d /.usr.rw ]; then
+		/bin/cromfs-driver /.usr.cromfs /.usr.ro
+		/bin/funionfs -o dirs=/.usr.ro=RO:/.usr.rw -o allow_other NONE /usr
+	else
+		/bin/cromfs /.usr.cromfs /usr
+	fi
+	status
+fi
+
 # Creat /dev/cdrom if needed (symlink does not exist on LiveCD). Chmod
EOF
}

# Pre and post install commands for Tazpkg.
pre_install()
{
    local $loram
    loram=$(cd /var/lib/tazpkg/installed ; ls -d slitaz-loram* 2> /dev/null)
    [ -n "$loram" ] && yes y | tazpkg remove $loram
}

post_install()
{
    get_patch | patch -p0
}

# Pre remove commands for Tazpkg.
pre_remove()
{
    [ -L /usr/bin/patch ] || get_patch | patch -R -p0
}
