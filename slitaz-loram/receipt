# SliTaz package receipt.

PACKAGE="slitaz-loram"
VERSION="1.1"
CATEGORY="misc"
SHORT_DESC="Rules to build low ram rootfs.gz."
MAINTAINER="pascal.bellard@slitaz.org"
DEPENDS="squashfs"

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
    mkdir -p $fs/etc/tazlito
    cat > $fs/etc/tazlito/loram.rootfs << EOF
echo "\$(du -hs ./usr | cut -f1) were used by /usr"
for ii in /sbin /lib /bin; do
  mkdir -p ./usr/.moved\$ii
  for j in e2fsprogs pcmciautils cpio syslinux-extra isapnptools ; do
    for k in \$(grep ^\$ii ./var/lib/tazpkg/installed/\$j/files.list) ; do
      [ -f .\$k ] || continue
      mv .\$k ./usr/.moved\$k
      ln -s /usr/.moved$k .\$k 
    done
  done
done
for ii in /var/lib/tazpkg/installed ; do
  j=\$(dirname /usr/.moved\$ii)
  mkdir -p .\$j
  mv .\$ii .\$j
  ln -s /usr/.moved\$ii .\$ii
done
echo "\$(du -hs ./usr/.moved | cut -f1) have been moved into /usr"
echo "\$(du -hs ./usr | cut -f1) were used by /usr before compression"
mksquashfs usr .usr.sqfs
rm -rf usr
mkdir usr
COMPRESSION="none"
echo "\$(du -hs ./.usr.sqfs | cut -f1) are used by /usr after compression"
EOF
}

get_patch()
{
    cat <<EOF
--- /etc/init.d/rcS
+++ /etc/init.d/rcS
@@ -79,2 +79,9 @@
 
+# Mount compressed /usr
+if [ -f /.usr.sqfs ]; then
+	echo -n "Mounting compressed /usr read-only... "
+	/bin/mount -o loop,ro -t squashfs /.usr.sqfs /usr
+	status
+fi
+
 # Handle kernel cmdline parameter config=<device>,<path> to source a 
EOF
}

# Pre and post install commands for Tazpkg.
post_install()
{
    get_patch | patch -p0
}

# Pre remove commands for Tazpkg.
pre_remove()
{
    get_patch | patch -R -p0
}
