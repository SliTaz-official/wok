# SliTaz package receipt.

PACKAGE="postgresql"
VERSION="9.0.1"
CATEGORY="misc"
SHORT_DESC="SQL database system."
MAINTAINER="pascal.bellard@slitaz.org"
TARBALL="$PACKAGE-$VERSION.tar.bz2"
WEB_SITE="http://www.postgresql.org/"
WGET_URL="http://wwwmaster.postgresql.org/redir/110/f/source/v$VERSION/$TARBALL"
DEPENDS="postgresql-client slitaz-base-files"
BUILD_DEPENDS="zlib-dev readline-dev ncurses-dev bison flex perl libxslt"
CONFIG_FILES="/var/lib/pgsql/*.conf"
DATABASE_FILES="/var/lib/pgsql"

# Rules to configure and make the package.
compile_rules()
{
	cd $src
	[ -d ../postgrpsql-$VERSION ] && cp -a ../postgrpsql-$VERSION/* .
	cp ../stuff/*.files-list .
	./configure --prefix=/usr --infodir=/usr/share/info \
	--sysconfdir=/etc --includedir=/usr/include/postgresql --with-gnu-ld \
	--with-includes=/usr/include/readline --enable-integer-datetimes \
	--enable-thread-safety --with-system-tzdata=/usr/share/zoneinfo \
	--libdir=/usr/lib/postgresql --mandir=/usr/share/man \
	$CONFIGURE_ARGS &&
	make &&
	make DESTDIR=$PWD/_pkg install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/share $fs/usr/lib $fs/var/lib/pgsql \
		 $fs/var/log/postgresql $fs/etc/pgsql.d
	cp -a $_pkg/usr/bin $fs/usr
	cp -a $_pkg/usr/lib/postgresql $fs/usr/lib
	strip -s $fs/usr/lib/postgresql/*.so*
	rm -f $fs/usr/lib/postgresql/*a
	cp -a $_pkg/usr/share/postgresql $fs/usr/share
	cp -a stuff/etc $fs
	ln -s /var/lib/pgsql/postgresql.conf $fs/etc
	chmod 700 $fs/var/lib/pgsql
	cat $src/*.files-list | while read file; do
		[ -f $fs$file ] && rm -f $fs$file
	done
	# Package all pgsql pkgs
	for i in $(cd $WOK; ls -d postgresql-* libpostgresql* )
	do
		tazwok genpkg $i
	done
}

# Pre and post install commands for Tazpkg.
post_install()
{
        # adduser postgres if needed
	if ! grep -q postgres $1/etc/passwd; then
		echo -n "Adding user postgres..."
		chroot $1/ adduser postgres -D -H -h /var/lib/pgsql
		rm -f /var/lib/pgsql/.* /var/lib/pgsql/*
		# ensure not to overload tux user
		i=1100
		while grep -q ":$i:" $1/etc/passwd ; do i=$(( $i + 1 )); done
		sed -i "s/^postgres:x:1000:1000:/postgres:x:$i:$i:/" $1/etc/passwd
		sed -i "s/^postgres:x:1000:/postgres:x:$i:/" $1/etc/group
		status
	fi
	# addgroup postgres if needed
	if ! grep -q postgres $1/etc/group; then
		echo -n "Adding group postgres..."
		chroot $1/ sh -c 'addgroup postgres && addgroup postgres postgres'
		status
	fi
	chroot $1/ chown -R postgres.postgres /var/lib/pgsql /var/log/postgresql
	cat <<EOF
----
postgres has superuser access.
Configure /var/lib/pgsql/*.conf files.
To start $PACKAGE server you can run :

    /etc/init.d/$PACKAGE start

Or add $PACKAGE to RUN_DAEMONS in /etc/rcS.conf
----
EOF
}

post_remove()
{
	deluser postgres
	delgroup postgres
}
