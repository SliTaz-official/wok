# SliTaz package receipt.

PACKAGE="zaptel"
VERSION="bristuff"
CATEGORY="misc"
SHORT_DESC="Zapata Telephony Interface Driver."
MAINTAINER="pascal.bellard@slitaz.org"
WEB_SITE="http://www.digium.com/"
DEPENDS="libusb newt linux"
WANTED="bristuff"
CONFIG_FILES="/etc/zaptel.conf"

# Extract VERSION from WANTED package source
get_version()
{
        eval $(grep ^ZAP_VER= $WOK/$WANTED/$WANTED-*/download.sh)
	VERSION=$WANTED-$ZAP_VER
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/etc/udev/rules.d
	get_version
	[ -d taz/$PACKAGE-$WANTED/fs ] && \
		mv taz/$PACKAGE-$WANTED taz/$PACKAGE-$VERSION
	kver=$(grep "kernel version" ../linux/$(ls ../linux/taz)/.config)
	kver=${kver##* }
	EXTRAVERSION=_$kver
	_pkg=$(cd $(dirname $src)/$WANTED-*/_pkg ; pwd)
	while read file; do
		dir=$(dirname $file)
		[ -d $fs$dir ] || mkdir -p $fs$dir
		eval cp -a "$_pkg$file" $fs$dir
	done < $_pkg/../$PACKAGE.files-list
	rm -f $fs/lib/modules/*/modules.*
	src=$(dirname $_pkg)
	cp $src/zaptel/build_tools/genudevrules $fs
	sed -i 's/^ver/ver=99 # ver/' $fs/genudevrules
	$fs/genudevrules | sed 's/asterisk/root/g' > $fs/etc/udev/rules.d/zaptel.rules
	rm -f $fs/genudevrules
	
}

# Post install/remove commands for Tazpkg.
post_install()
{
	chroot "$1/" depmod -a ${EXTRAVERSION#_}-slitaz
	tazpkg reconfigure udev --root=$1
}

post_remove()
{
	depmod -a
}
