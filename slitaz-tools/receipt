# SliTaz package receipt.

PACKAGE="slitaz-tools"
VERSION="2.8.1"
CATEGORY="system-tools"
SHORT_DESC="SliTaz tools provide installer and Tinyutils."
MAINTAINER="pankso@slitaz.org"
DEPENDS="slitaz-boot-scripts dialog gtkdialog"
TARBALL="$PACKAGE-$VERSION.tar.gz"
WEB_SITE="http://www.slitaz.org/"
WGET_URL="http://mirror.slitaz.org/sources/tools/$TARBALL"
CONFIG_FILES="
/etc/TZ
/etc/motd
/etc/keymap.conf
/etc/X11/screen.conf
/etc/locale.conf
/etc/firewall.conf"

# Rules to gen a SliTaz package suitable for Tazpkg.
#
# This package is all build by genpkg, it provide /usr/share/examples tree,
# tazlito, tinyutils, licenses, documentation and artwork. This package
# provide also the Firewall deamon/config (/etc/firewall.conf).
#
genpkg_rules()
{
	mkdir -p \
		$fs/sbin \
		$fs/usr/bin \
		$fs/usr/sbin \
		$fs/etc/X11 \
		$fs/var/spool/cron/crontabs \
		$fs/usr/lib/slitaz \
		$fs/usr/share/doc/slitaz-tools \
		$fs/usr/share/slitaz-tools/glade \
		$fs/usr/share/slitaz-tools/installer

	# /rootfs/*. Firewall exemples, licenses, pixmaps and desktop files.
	cp -a $src/rootfs/* $fs

	# Tinyutils.
	cp -a $src/tinyutils/tazlocale $fs/sbin
	touch $fs/etc/locale.conf
	touch $fs/etc/motd
	cp -a $src/tinyutils/tazkeymap $fs/sbin
	touch $fs/etc/keymap.conf
	touch $fs/etc/TZ
	cp -a $src/tinyutils/gztazmod.sh $fs/sbin
	cp -a $src/tinyutils/tazx $fs/usr/bin
	touch $fs/etc/X11/screen.conf
	cp -a $src/tinyutils/startx $fs/usr/bin
	cp -a $src/tinyutils/history $fs/usr/bin
	cp -a $src/tinyutils/tazdialog $fs/usr/bin
	# Sound config
	cp -a $src/tinyutils/soundconf $fs/usr/sbin
	cp -a $src/tinyutils/setmixer $fs/usr/sbin
	
	# Gtkdialog boxes
	cp -a $src/tinyutils/bootfloppybox $fs/usr/bin
	cp -a $src/tinyutils/burnbox $fs/usr/bin
	cp -a $src/tinyutils/mountbox $fs/usr/bin
	cp -a $src/tinyutils/netbox $fs/usr/bin
	cp -a $src/tinyutils/scpbox $fs/usr/bin
	cp -a $src/tinyutils/subox $fs/usr/bin
	cp -a $src/tinyutils/desktopbox $fs/usr/bin
	cp -a $src/tinyutils/tazctrlbox $fs/usr/sbin

	# Libs and Glade XML files.
	cp -a $src/lib/[a-z]* $fs/usr/lib/slitaz
	cp -a $src/glade/*.glade $fs/usr/share/slitaz-tools/glade

	# Installer's
	cp -a $src/installer/slitaz-installer $fs/usr/bin
	cp -a $src/installer/*.msg $fs/usr/share/slitaz-tools/installer

	# Tools doc in /usr/share/doc/slitaz-tools
	cp $src/doc/* $fs/usr/share/doc/slitaz-tools

	# Gksu fake for pcmanfm
	cd $fs/usr/bin
	ln -s subox gksu
	cd $WOK/$PACKAGE

	chown -R root.root $fs
	chmod -R 755 $fs/usr/bin
	chmod -R 755 $fs/sbin
}

# Pre install commands.
pre_install()
{
 	local root
 	root=$1
	# Backup file to restore with post install
	echo "Creating backups of configs..."
	cp $root/etc/TZ $root/etc/TZ.bak 2>/dev/null
	cp $root/etc/keymap.conf $root/etc/keymap.conf.bak 2>/dev/null
	cp $root/etc/X11/screen.conf $root/etc/X11/screen.conf.bak 2>/dev/null
	cp $root/etc/locale.conf $root/etc/locale.conf.bak 2>/dev/null
	cp $root/etc/firewall.conf $root/etc/firewall.conf.bak 2>/dev/null
}

# Post install
post_install()
{
	echo "Restoring configs backups..."
	mv -f $root/etc/TZ.bak $root/etc/TZ 2>/dev/null
	mv -f $root/etc/keymap.conf.bak $root/etc/keymap.conf 2>/dev/null
	mv -f $root/etc/X11/screen.conf.bak $root/etc/X11/screen.conf 2>/dev/null
	mv -f $root/etc/locale.conf.bak $root/etc/locale.conf 2>/dev/null
	mv -f $root/etc/firewall.conf.bak $root/etc/firewall.conf 2>/dev/null
}
