# SliTaz package receipt.

PACKAGE="slitaz-tools"
VERSION="3.7"
CATEGORY="system-tools"
SHORT_DESC="SliTaz tools provide installer and utils usable on termnial."
MAINTAINER="pankso@slitaz.org"
DEPENDS="slitaz-boot-scripts dialog"
SUGGESTED="slitaz-tools-boxes"
TARBALL="$PACKAGE-$VERSION.tar.gz"
WEB_SITE="http://www.slitaz.org/"
WGET_URL="http://mirror.slitaz.org/sources/tools/$TARBALL"
CONFIG_FILES="
/etc/TZ
/etc/motd
/etc/keymap.conf
/etc/X11/screen.conf
/etc/locale.conf
/etc/firewall.conf
/etc/slitaz/applications.conf"

# Rules to configure and make the package.
compile_rules()
{
    cd $src
    make msgfmt
}

# Rules to gen a SliTaz package suitable for Tazpkg.
#
# This package is moslty build by genpkg, it provide /usr/share/examples tree,
# tazlito, tinyutils, licenses, documentation and artwork. This package
# provide also the Firewall deamon/config (/etc/firewall.conf).
#
genpkg_rules()
{
	mkdir -p \
		$fs/sbin \
		$fs/usr/bin \
		$fs/usr/sbin \
		$fs/etc/X11 \
		$fs/var/spool/cron/crontabs \
		$fs/usr/share/slitaz/messages/en
	# /rootfs/*. Firewall exemples, licenses, pixmaps and desktop files.
	cp -a $src/rootfs/* $fs
	rm -rf $fs/usr/share/applications
	rm -rf $fs/usr/share/pixmaps
	# Tinyutils and declare all config files.
	cp -a $src/tinyutils/tazlocale $fs/sbin
	touch $fs/etc/locale.conf
	touch $fs/etc/motd
	cp -a $src/tinyutils/tazkeymap $fs/sbin
	touch $fs/etc/keymap.conf
	touch $fs/etc/TZ
	cp -a $src/tinyutils/gztazmod.sh $fs/sbin
	cp -a $src/tinyutils/tazx $fs/usr/bin
	touch $fs/etc/X11/screen.conf
	cp -a $src/tinyutils/tazhw $fs/sbin
	cp -a $src/tinyutils/hwsetup $fs/sbin
	for app in startx history tazdialog editor browser terminal file-manager
	do
		cp -a $src/tinyutils/$app $fs/usr/bin
	done
	# Sound config
	cp -a $src/tinyutils/soundconf $fs/usr/sbin
	cp -a $src/tinyutils/setmixer $fs/usr/sbin
	# Installer's
	cp -a $src/installer/slitaz-installer $fs/usr/bin
	cp -a $src/messages/en/installer.msg $fs/usr/share/slitaz/messages/en
	chown -R root.root $fs
	chmod -R 755 $fs/usr/bin
	chmod -R 755 $fs/sbin
}

# Pre install commands.
pre_install()
{
 	local root
 	root=$1
	# Backup file to restore with post install
	echo "Creating backups of configs..."
	cp $root/etc/TZ $root/etc/TZ.bak 2>/dev/null
	cp $root/etc/keymap.conf $root/etc/keymap.conf.bak 2>/dev/null
	cp $root/etc/X11/screen.conf $root/etc/X11/screen.conf.bak 2>/dev/null
	cp $root/etc/locale.conf $root/etc/locale.conf.bak 2>/dev/null
	cp $root/etc/firewall.conf $root/etc/firewall.conf.bak 2>/dev/null
}

# Post install
post_install()
{
	echo "Restoring configs backups..."
	mv -f $root/etc/TZ.bak $root/etc/TZ 2>/dev/null
	mv -f $root/etc/keymap.conf.bak $root/etc/keymap.conf 2>/dev/null
	mv -f $root/etc/X11/screen.conf.bak $root/etc/X11/screen.conf 2>/dev/null
	mv -f $root/etc/locale.conf.bak $root/etc/locale.conf 2>/dev/null
	mv -f $root/etc/firewall.conf.bak $root/etc/firewall.conf 2>/dev/null
	# Install boxes package if old slitaz-tools
	if [ -f $root/usr/bin/mountbox ] && [ ! -d /var/lib/tazpkg/installed/slitaz-tools-boxes ]; then
		tazpkg get-install slitaz-tools-boxes
	fi
	# Remove old files
	rm -rf $root/usr/share/slitaz-tools
	rm -rf $root/usr/share/doc/slitaz-tools
}
