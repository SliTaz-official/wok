#!/bin/sh -e

if test $(id -u) != 0 ; then
	echo -e "\nYou must be root to run `basename $0`."
	echo -e "Please type 'su' and root password to become super-user.\n"
	exit 0
fi

if [ -d /var/lib/tazpkg/installed/flash-plugin ]; then
  tazpkg remove flash-plugin
  [ -d /var/lib/tazpkg/installed/flash-plugin ] && exit 1
fi
DIR=install_flash_player_9_linux
TARBALL=$DIR.tar.gz
WEB_SITE="http://www.adobe.com/products/flash/"

# Download tarball
wget http://fpdownload.macromedia.com/get/flashplayer/current/$TARBALL

# Extract
tar xzf $TARBALL

cd $DIR
VERSION=""
for i in MAJ MIN REV ; do
  n=$(grep ^FPVERSION$i flashplayer-installer | cut -d= -f2)
  [ -n "$VERSION" ] && VERSION=$VERSION.
  VERSION=$VERSION$n
done

# Install files
chmod 755 libflashplayer.so
mv libflashplayer.so /usr/lib/firefox*/plugins

# Create pseudo package
while read file; do
	dest=flash-plugin-$VERSION/fs$(dirname $file)
	[ -d $dest ] || mkdir -p $dest
	cp -a $file $dest
done <<EOT
$(ls /usr/lib/firefox*/plugins/libflashplayer.so)
EOT
cat > flash-plugin-$VERSION/receipt <<EOT
PACKAGE="flash-plugin"
VERSION="$VERSION"
CATEGORY="non-free"
SHORT_DESC="Adobe Flash Player."
WEB_SITE="$WEB_SITE"
EOT

# Pack
tazpkg pack flash-plugin-$VERSION

# Install pseudo package
tazpkg install flash-plugin-$VERSION.tazpkg
cd ..

# Clean
rm -rf $DIR $TARBALL

