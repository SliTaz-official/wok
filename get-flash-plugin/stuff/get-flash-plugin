#!/bin/sh -e

[ -f /etc/slitaz/slitaz.conf ] && . /etc/slitaz/slitaz.conf
[ $INSTALLED ] || INSTALLED=/var/lib/tazpkg/installed

PACKAGE="flash-plugin"
WEB_SITE="http://www.adobe.com/products/flash/"
SHORT_DESC="Adobe Flash Player."
ROOT="$1"
[ -d "$ROOT" ] || ROOT=""

if test $(id -u) != 0 ; then
	echo -e "\nYou must be root to run `basename $0`."
	echo -e "Please type 'su' and root password to become super-user.\n"
	exit 0
fi

if [ -d ${ROOT}${INSTALLED}/$PACKAGE ]; then
  [ -n "$ROOT" ] && exit 1
  tazpkg remove $PACKAGE
  [ -d $INSTALLED/$PACKAGE ] && exit 1
fi

VERSION=11.2.202.350

URL=http://fpdownload.macromedia.com/get/flashplayer/pdc/$VERSION/install_flash_player_11_linux.i386.tar.gz
TMP_DIR=/tmp/get-$PACKAGE-$$-$RANDOM
CUR_DIR=$(pwd)
mkdir -p $TMP_DIR && cd $TMP_DIR
TARBALL="install_flash_player_11_linux.i386.tar.gz"
busybox wget -O $TARBALL $URL

if [ ! -f $TARBALL ]; then
	echo "Could not download $TARBALL. Exiting."
	exit 1
fi

tar xzf $TARBALL

# Install files
chmod 755 libflashplayer.so
chown root.root libflashplayer.so
dir=$PACKAGE-$VERSION/fs
mkdir -p $dir/usr/share/flash
mv libflashplayer.so $dir/usr/share/flash
mv usr/bin $dir/usr
mv usr/share/icons $dir/usr/share
mv usr/share/pixmaps $dir/usr/share

# Sanity Check: Reexport firefox libraries if they don't exist
dir=$PACKAGE-$VERSION/fs/usr/lib
mkdir -p $dir
for i in /usr/lib/firefox/*.so ; do
  	[ -f $i ] && [ -z "`ls /usr/lib/$(basename $i)`" ] && ln -s $i $dir	
done

# Create pseudo package
cat > $PACKAGE-$VERSION/receipt <<EOT
PACKAGE="$PACKAGE"
VERSION="$VERSION"
CATEGORY="non-free"
SHORT_DESC="$SHORT_DESC"
WEB_SITE="$WEB_SITE"
DEPENDS="libfirefox curl atk cairo expat fontconfig freetype glib gtk+ libpng \
nss pango pixman xorg-libICE xorg-libSM xorg-libX11 xorg-libXau xorg-libXcomposite \
xorg-libXcursor xorg-libXdamage xorg-libXdmcp xorg-libXext xorg-libXfixes \
xorg-libXinerama xorg-libXrandr xorg-libXrender xorg-libXt zlib"

post_install()
{
	echo -n "Processing post install commands..."
 
	[ -d \$1/usr/lib/mozilla/plugins ] || mkdir -p \$1/usr/lib/mozilla/plugins
	ln -s /usr/share/flash/libflashplayer.so \$1/usr/lib/mozilla/plugins
	[ -d \$1/opt/google/chrome/plugins ] || mkdir -p \$1/opt/google/chrome/plugins
	ln -s /usr/share/flash/libflashplayer.so \$1/opt/google/chrome/plugins/libgcflashplayer.so
	[ -d \$1/usr/lib/opera/plugins ] || mkdir -p \$1/usr/lib/opera/plugins
	ln -s /usr/share/flash/libflashplayer.so \$1/usr/lib/opera/plugins/libflashplayer.so
	status
}

post_remove()
{
	echo -n "Processing post remove commands..."
	rm -f \$1/usr/lib/mozilla/plugins/libflashplayer.so
	rm -f \$1/opt/google/chrome/plugins/libgcflashplayer.so
	rm -f \$1/usr/lib/opera/plugins/libflashplayer.so
	status
}
EOT

# Pack
tazpkg pack $PACKAGE-$VERSION

# Install pseudo package
tazpkg install $PACKAGE-$VERSION.tazpkg --root=$ROOT
case " $@ " in
*\ --k*) mv $PACKAGE-$VERSION.tazpkg $CUR_DIR ;;
esac

# Clean
cd $CUR_DIR
rm -rf $TMP_DIR
