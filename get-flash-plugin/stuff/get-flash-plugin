#!/bin/sh -e
: ${DIALOG=tazdialog}

if test $(id -u) != 0 ; then
	echo -e "\nYou must be root to run `basename $0`."
	echo -e "Please type 'su' and root password to become super-user.\n"
	exit 0
fi

if [ -d /var/lib/tazpkg/installed/flash-plugin ]; then
  tazpkg remove flash-plugin
  [ -d /var/lib/tazpkg/installed/flash-plugin ] && exit 1
fi
WEB_SITE="http://www.adobe.com/products/flash/"
URL="http://fpdownload.macromedia.com/get/flashplayer/current/"

# Download tarball
VERSIONS=""
for i in $(seq 20 -1 7); do
  wget -s ${URL}install_flash_player_${i}_linux.tar.gz 2> /dev/null || continue
  VERSIONS="$VERSIONS $i"
done

value="$(echo $VERSIONS)"
case "$VERSIONS" in
*[0-9]\ [1-9]*)
	exec 3>&1
	value=`$DIALOG --clear --colors --title " Install Flash plugin " \
		--menu  "Which version to install" 16 70 5 \
		$(for i in $VERSIONS; do echo $i; echo "flash-$i"; done) \
		2>&1 1>&3`
	retval=$?
	exec 3>&-
	[ -n "$value" ] || exit 0
	[ "$retval" = "1" ] && exit 0
esac
DIR=install_flash_player_${value}_linux
TARBALL=$DIR.tar.gz
wget $URL$TARBALL

# Extract
tar xzf $TARBALL

cd $DIR
VERSION=""
for i in MAJ MIN REV ; do
  n=$(grep ^FPVERSION$i flashplayer-installer | cut -d= -f2)
  [ -n "$VERSION" ] && VERSION=$VERSION.
  VERSION=$VERSION$n
done

# Install files
chmod 755 libflashplayer.so
chown root.root libflashplayer.so
mv libflashplayer.so /usr/lib/firefox*/plugins

# Create pseudo package
while read file; do
	dest=flash-plugin-$VERSION/fs$(dirname $file)
	[ -d $dest ] || mkdir -p $dest
	cp -a $file $dest
done <<EOT
$(ls /usr/lib/firefox*/plugins/libflashplayer.so)
EOT
cat > flash-plugin-$VERSION/receipt <<EOT
PACKAGE="flash-plugin"
VERSION="$VERSION"
CATEGORY="non-free"
SHORT_DESC="Adobe Flash Player."
WEB_SITE="$WEB_SITE"
EOT

# Pack
tazpkg pack flash-plugin-$VERSION

# Install pseudo package
tazpkg install flash-plugin-$VERSION.tazpkg
cd ..

# Clean
rm -rf $DIR $TARBALL

