#!/bin/sh
# install linux-wireless, wireless_tools and b43-fwcutter if needed.

MODULE=$(echo $0 | sed 's/.*get-\(.*\)-firmware/\1/')
ROOT="$2"
PKG=$MODULE-firmware
DEPENDS=""
case "$MODULE" in
b43)
	VERSION=4.150.10.5
	SUBDIR="broadcom-wl-$VERSION"
	SHORT_DESC="Broadcom $MODULE firmware."
	WEB_SITE="http://www.linuxwireless.org/en/users/Drivers/b43"
	WGET_URL="http://mirror2.openwrt.org/sources/$SUBDIR.tar.bz2"
	DEPENDS="b43-fwcutter"
	FWSET=wl_apsta_mimo.o
	;;
b43legacy)
	VERSION=3.130.20.0
	SHORT_DESC="Broadcom $MODULE firmware (BCM4306 rev2 or 802.11b chips)."
	WEB_SITE="http://downloads.openwrt.org/"
	WGET_URL="${WEB_SITE}sources/wl_apsta-$VERSION.o"
	DEPENDS="b43-fwcutter"
	FWSET=wl_apsta-$VERSION.o
	;;
ipw2100)
	VERSION=1.3
	SHORT_DESC="Intel PRO/Wireless 2100 firmware."
	WEB_SITE="http://$MODULE.sourceforge.net/"
	WGET_URL="http://bughost.org/firmware/${MODULE}-fw-${VERSION}.tgz"
	;;
ipw2200)
	VERSION=3.1
	SHORT_DESC="Intel PRO/Wireless 2200BG firmware."
	WEB_SITE="http://$MODULE.sourceforge.net/"
	WGET_URL="http://bughost.org/firmware/${MODULE}-fw-${VERSION}.tgz"
	;;
iwlwifi-3945)
	VERSION=15.32.2.9
	SHORT_DESC="Intel PRO/Wireless 3945ABG/BG firmware."
	WEB_SITE="http://www.intellinuxwireless.org/?n=Downloads"
	WGET_URL="http://www.intellinuxwireless.org/iwlwifi/downloads/$MODULE-ucode-$VERSION.tgz"
	;;
iwlwifi-4965)
	VERSION=228.61.2.24
	SHORT_DESC="Intel WiFi Link 4965AGN firmware."
	WEB_SITE="http://www.intellinuxwireless.org/?n=Downloads"
	WGET_URL="http://www.intellinuxwireless.org/iwlwifi/downloads/$MODULE-ucode-$VERSION.tgz"
	;;
iwlwifi-5000)
	VERSION=8.24.2.12
	SHORT_DESC="Intel Wireless WiFi Link 5000AGN firmware."
	WEB_SITE="http://www.intellinuxwireless.org/?n=Downloads"
	WGET_URL="http://www.intellinuxwireless.org/iwlwifi/downloads/$MODULE-ucode-$VERSION.tgz"
	;;
iwlwifi-5150)
	VERSION=8.24.2.2
	SHORT_DESC="Intel Wireless WiFi Link 5150AGN firmware."
	WEB_SITE="http://www.intellinuxwireless.org/?n=Downloads"
	WGET_URL="http://www.intellinuxwireless.org/iwlwifi/downloads/$MODULE-ucode-$VERSION.tgz"
	;;
iwlwifi-1000)
	VERSION=128.50.3.1
	SHORT_DESC="Intel Wireless WiFi Link 1000BGN firmware."
	WEB_SITE="http://www.intellinuxwireless.org/?n=Downloads"
	WGET_URL="http://www.intellinuxwireless.org/iwlwifi/downloads/$MODULE-ucode-$VERSION.tgz"
	;;
iwlwifi-6000)
	VERSION=9.176.4.1
	SHORT_DESC="Intel Wireless WiFi Link 6000 Series Wi-fi Adapters"
	WEB_SITE="http://www.intellinuxwireless.org/?n=Downloads"
	WGET_URL="http://www.intellinuxwireless.org/iwlwifi/downloads/$MODULE-ucode-$VERSION.tgz"
	;;
rt61|rt61pci)
	VERSION=1.2
	SHORT_DESC="new RT2x00 RT61 Wireless Lan firmware."
	WEB_SITE="http://www.ralinktech.com/"
	WGET_URL="ftp://ftp.archlinux.org/other/rt2x00-rt61-fw/RT61_Firmware_V${VERSION}.zip"
	;;
rt73|rt73usb)
	VERSION=1.8
	SHORT_DESC="new RT2x00 RT73(RT2571W) Wireless Lan firmware."
	WEB_SITE="http://www.ralinktech.com/"
	WGET_URL="ftp://ftp.archlinux.org/other/rt2x00-rt71w-fw/RT71W_Firmware_V${VERSION}.zip"
	;;
rt2870usb)
	VERSION=8
	SHORT_DESC="RaLink RT2870USB (RT2870/RT2770) WiFi adapter."
	WEB_SITE="http://www.ralinktech.com/"
	WGET_URL="ftp://ftp.archlinux.org/other/${MODULE}-fw/RT2870_Firmware_V${VERSION}.zip"
	;;
zd1211|zd1211rw)
	VERSION=2.21.0.0-1
	SHORT_DESC="zd1211/zd1211rw Wireless Lan firmware."
	WEB_SITE="http://packages.debian.org/etch/zd1211-firmware"
	WGET_URL="http://mirrors.kernel.org/debian/pool/non-free/z/zd1211-firmware/zd1211-firmware_${VERSION}_all.deb"
	;;
*)	echo "Unknown wifi driver. Please run one of the following commands:"
	for i in $(cd $(dirname $0); ls get-*-firmware); do
		[ -L $i ] || continue
		[ "$(readlink $i)" = "get-wifi-firmware" ] || continue
		echo "  $i"
	done
	exit 1;;
esac

# Check if user is root to install.
if test $(id -u) != 0 ; then
        echo -e "\nYou must be root to run `basename $0`."
	echo -e "Please use 'su' and root password to become super-user.\n"
	exit 0
fi

# Avoid reinstall
if [ -d $ROOT/var/lib/tazpkg/installed/$PKG ]; then
	echo -e "\n$PKG package is already installed.\n"
	exit 0
fi

# We need drivers, the extractor and tools.
for pkg in linux-wireless wireless_tools $DEPENDS
do
	if [ ! -d $ROOT/var/lib/tazpkg/installed/$pkg ]; then
		tazpkg get-install $pkg --root=$ROOT
	fi
done

# Get files
TMP=/tmp/$(basename $0)$$
mkdir $TMP
TOP=$PWD
cd $TMP
wget $WGET_URL
TARBALL="$(basename $WGET_URL)"
if [ ! -f $TARBALL ]; then
	cd $TOP
	rm -rf $DIR
	echo "Could not download $TARBALL. Exiting."
	exit 1
fi

case "$WGET_URL" in
*rpm)	rpm2cpio < $TARBALL | cpio -id;;
*deb)	dpkg-deb -x $TARBALL . ;;
*bz2)	tar xjf $TARBALL
	cd $SUBDIR/driver;;
*tar.gz|*tgz)	tar xzf $TARBALL;;
*zip)	unzip $TARBALL;;
*o)	;;
esac
	
# Create pseudo package
mkdir -p $PKG-$VERSION/fs/lib/firmware $PKG-$VERSION/fs/usr/share/licenses
case "$MODULE" in 
b43*)	b43-fwcutter -w "$PKG-$VERSION/fs/lib/firmware" $FWSET;;
ipw2200)	cp ${MODULE}-fw-$VERSION/*LICENSE* $PKG-$VERSION/fs/usr/share/licenses/intel-$MODULE-LICENSE.txt
			mv ${MODULE}-fw-$VERSION/* $PKG-$VERSION/fs/lib/firmware;;
ipw2100)	cp *LICENSE* $PKG-$VERSION/fs/usr/share/licenses/intel-$MODULE-LICENSE.txt
			mv *.fw* *LICENSE* $PKG-$VERSION/fs/lib/firmware;;
rt*)
	mv RT*_Firmware_V$VERSION/*.bin $PKG-$VERSION/fs/lib/firmware
	mv RT*_Firmware_V$VERSION/*LICENSE* $PKG-$VERSION/fs/usr/share/licenses/ralink-rt61-LICENSE.txt;;
iwlwifi*) mv iwlwifi*/iwlwifi*.ucode $PKG-$VERSION/fs/lib/firmware
		  mv iwlwifi*/*LICENSE* $PKG-$VERSION/fs/usr/share/licenses/intel-iwlwifi-LICENSE.txt	;;
zd1211|zd1211rw)
	mv lib/firmware/zd1211 $PKG-$VERSION/fs/lib/firmware 
	for i in $(cd usr/lib/hotplug/firmware; ls); do
		target=$(readlink usr/lib/hotplug/firmware/$i)
		ln -s $(basename $target) $PKG-$VERSION/fs/lib/firmware/zd1211/$i
	done;;
esac

# Creat receipt
cat > $PKG-$VERSION/receipt <<EOT
PACKAGE="$PKG"
VERSION="$VERSION"
CATEGORY="non-free"
SHORT_DESC="$SHORT_DESC."
WEB_SITE="$WEB_SITE"
DEPENDS="linux-wireless wireless_tools $DEPENDS"
EOT

# Pack
tazpkg pack $PKG-$VERSION

# Install pseudo package
tazpkg install $PKG-$VERSION.tazpkg --root=$ROOT

# Clean
cd $TOP
rm -rf $TMP

if [ "$1" == "--firmware" ] ; then 
    echo "just install firmare: yes"
    JUST_INSTALL_FIRMWARE="yes"
fi

if [ ! "$JUST_INSTALL_FIRMWARE" == "yes" ]; then
	echo "configuring and loading module ..."
	# Check if we need wpa_supplicant
	. $ROOT/etc/network.conf
	if [ $WIFI_KEY_TYPE = "wpa" ] || [ $WIFI_KEY_TYPE = "WPA" ]; then
		if [ ! -d $ROOT/var/lib/tazpkg/installed/wpa_supplicant ]; then
			tazpkg get-install wpa_supplicant --root=$ROOT
		fi
	fi

	# Configure /etc/network.conf and start connexion
	sed -i s/'WIFI="no"'/'WIFI="yes"'/ $ROOT/etc/network.conf

	# Load module
	if [ -z "$ROOT" -a -n "$(modprobe -l $MODULE)" ]; then
		echo "Loading module: $MODULE..."
		if modprobe $MODULE ; then
			sleep 2
			/etc/init.d/network.sh restart
		fi
	fi
fi

