#!/bin/sh
# install linux-wireless, wireless_tools and b43-fwcutter if needed.

MODULE=$(echo $0 | sed 's/.*get-\(.*\)-firmware/\1/')
ROOT="$1"
PKG=$MODULE-firmware
DEPENDS=""
case "$MODULE" in
b43)
	VERSION=4.80.53.0
	SUBDIR="broadcom-wl-$VERSION"
	SHORT_DESC="Broadcom $MODULE firmware."
	WEB_SITE="http://downloads.openwrt.org/"
	WGET_URL="${WEB_SITE}sources/$SUBDIR.tar.bz2"
	DEPENDS="b43-fwcutter"
	FWSET=wl_apsta.o
	;;
b43legacy)
	VERSION=3.130.20.0
	SHORT_DESC="Broadcom $MODULE firmware."
	WEB_SITE="http://downloads.openwrt.org/"
	WGET_URL="${WEB_SITE}sources/wl_apsta-$VERSION.o"
	DEPENDS="b43-fwcutter"
	FWSET=wl_apsta-$VERSION.o
	;;
ipw2100)
	VERSION=1.3-6.0.1
	SHORT_DESC="Intel PRO/Wireless 2100 firmware."
	WEB_SITE="http://$MODULE.sourceforge.net/"
	WGET_URL="http://dl.atrpms.net/all/$PKG-$VERSION.noarch.rpm"
	;;
ipw2200)
	VERSION=3.0-9.0.1
	SHORT_DESC="Intel PRO/Wireless 2200BG firmware."
	WEB_SITE="http://$MODULE.sourceforge.net/"
	WGET_URL="http://dl.atrpms.net/all/$PKG-$VERSION.noarch.rpm"
	;;
rt61)
	VERSION=1.2
	SHORT_DESC="RT61 Wireless Lan firmware."
	WEB_SITE="http://www.ralinktech.com/"
	WGET_URL="http://www.ralinktech.com.tw/data/RT61_Firmware_V$VERSION.zip"
	;;
rt73)
	VERSION=1.0.3.6
	SHORT_DESC="RT73(RT2571W) Wireless Lan firmware."
	WEB_SITE="http://www.ralinktech.com/"
	WGET_URL="http://www.ralink.com.tw/data/RT73_Linux_STA_Drv$VERSION.tar.gz"
	;;
*)	echo "Unknown wifi driver. Please run one of the following commands:"
	for i in $(cd $(dirname $0); ls get-*-firmware); do
		[ "$i" = "get-wifi-firmware" ] && continue
		echo "  $i"
	done
	exit 1;;
esac

# Check if user is root to install.
if test $(id -u) != 0 ; then
        echo -e "\nYou must be root to run `basename $0`."
	echo -e "Please use 'su' and root password to become super-user.\n"
	exit 0
fi

# Avoid reinstall
if [ -d $ROOT/var/lib/tazpkg/installed/$PKG ]; then
	echo -e "\n$PKG package is already installed.\n"
	exit 0
fi

# We need drivers, the extractor and tools.
for pkg in linux-wireless wireless_tools $DEPENDS
do
	if [ ! -d /var/lib/tazpkg/installed/$pkg ]; then
		tazpkg get-install $pkg
	fi
done

# Get files
TMP=/tmp/$(basename $0)$$
mkdir $TMP
TOP=$PWD
cd $TMP
wget $WGET_URL
case "$WGET_URL" in
*rpm)	rpm2cpio < $(basename $WGET_URL) | cpio -id;;
*bz2)	tar xjf $(basename $WGET_URL)
	cd $SUBDIR/kmod;;
*tar.gz)	tar xzf $(basename $WGET_URL);;
*zip)	unzip $(basename $WGET_URL);;
*o)	;;
esac
	
# Create pseudo package
mkdir -p $PKG-$VERSION/fs/lib/firmware
case "$MODULE" in 
b43*)	b43-fwcutter -w "$PKG-$VERSION/fs/lib/firmware" $FWSET;;
ipw*)	rm -f lib/firmware/*LICENSE*
	mv lib/firmware/* $PKG-$VERSION/fs/lib/firmware;;
rt61)	mv RT61_Firmware_V$VERSION/$PKG-$VERSION/fs/lib/firmware;;
rt73)	mv RT73_Linux_STA_Drv$VERSION/Module/rt73.bin $PKG-$VERSION/fs/lib/firmware;;
esac

# Creat receipt
cat > $PKG-$VERSION/receipt <<EOT
PACKAGE="$PKG"
VERSION="$VERSION"
CATEGORY="non-free"
SHORT_DESC="$SHORT_DESC."
WEB_SITE="$WEB_SITE"
DEPENDS="linux-wireless wireless_tools $DEPENDS"
EOT

# Pack
tazpkg pack $PKG-$VERSION

# Install pseudo package
tazpkg install $PKG-$VERSION.tazpkg --root=$ROOT

# Clean
cd $TOP
rm -rf $TMP

# Check if we need wpa_supplicant
. $ROOT/etc/network.conf
if [ $WIFI_KEY_TYPE = "wpa" ] || [ $WIFI_KEY_TYPE = "WPA" ]; then
	if [ ! -d $ROOT/var/lib/tazpkg/installed/wpa_supplicant ]; then
		tazpkg get-install wpa_supplicant --root=$ROOT
	fi
fi

# Configure /etc/network.conf and start connexion
sed -i s/'WIFI="no"'/'WIFI="yes"'/ $ROOT/etc/network.conf

# Load module
if [ -z "$ROOT" ]; then
	echo "Loading module: $MODULE..."
	if modprobe $MODULE ; then
		sleep 2
		/etc/init.d/network.sh restart
	fi
fi

