#!/bin/sh -e

PACKAGE="opera"
URL=http://mirrors.dedipower.com/opera/linux/
ROOT="$1"
[ -d "$ROOT" ] || ROOT=""

if test $(id -u) != 0 ; then
        echo -e "\nYou must be root to run `basename $0`."
        echo -e "Please type 'su' and root password to become super-user.\n"
        exit 0
fi

if [ -d $ROOT/var/lib/tazpkg/installed/$PACKAGE ]; then
	[ -n "$ROOT" ] && exit 1
	tazpkg remove $PACKAGE
	[ -d /var/lib/tazpkg/installed/$PACKAGE ] && exit 1
fi

TMP_DIR=/tmp/get-$PACKAGE-$$-$RANDOM
CUR_DIR=$(pwd)
mkdir -p $TMP_DIR && cd $TMP_DIR

get_releases()
{
	wget -qO- "$URL?C=M;O=D" | sed 's|.*[Ff]="\([^"/]*\).*|\1|;/[^0-9b]/d'
}

# Download deb
for RELEASE in $@ $(get_releases); do
	FILE=$(wget -O- "$URL$RELEASE/" 2>/dev/null | sed 's|.*[Ff]="\(.*\)".*|\1|;/6.d/!d;q')
	[ -n "$FILE" ] || continue
	wget $URL$RELEASE/$FILE
	[ -s $FILE ] && break
done

if [ ! -f $FILE ]; then
	cd $CUR_DIR
	rm -rf $TMP_DIR
	echo "Could not download $FILE from $URL. Exiting."
	exit 1
fi

mkdir opera
dpkg-deb -e $FILE opera/meta
dpkg-deb -x $FILE opera/fs
# extracted pkg can be removed: Save RAM
rm -f $FILE
sed '/^Description:/,$!d;s/^Description://' \
	< opera/meta/control > opera/description.txt

VERSION=$(grep ^Version opera/meta/control | awk '{ print $2 }')
mv opera opera-$VERSION
cd opera-$VERSION/fs

# Create menu
mkdir -p usr/share/applications
cat > usr/share/applications/opera-browser.desktop <<EOT
[Desktop Entry]
Version=1.0
TryExec=opera
Encoding=UTF-8
Name=Opera
Name[af]=opera
Name[eo]=Opero
Name[zu]=I Opera
GenericName=Web browser
GenericName[bs]=Web preglednik
GenericName[de]=Web-Browser
GenericName[eo]=TTT-rigardilo
GenericName[es]=Navegador web
GenericName[et]=Veebibrauser
GenericName[eu]=Web arakatzailea
GenericName[fi]=WWW-selain
GenericName[fr]=Un navigateur web
GenericName[is]=Vafri
GenericName[it]=Browser Web
GenericName[nl]=webbrowser
GenericName[nn]=Nettlesar
GenericName[pt]=Navegador Web
GenericName[pt_BR]=Navegador
GenericName[ro]=Navigator de web
GenericName[sl]=Spletni brskalnik
GenericName[ven]=Buronza ya Webu
GenericName[xh]=Umkhangeli Zincwadi Zokubhaliweyo
GenericName[zu]=Umkhangeli zincwadi we Web
Exec=opera %u
Terminal=false
Categories=Application;Qt;Network;WebBrowser;X-Ximian-Main;X-Ximian-Toplevel
Icon=opera-browser.png
MimeType=text/html;text/xml;application/xhtml+xml;application/x-mimearchive;application/xml;application/rss+xml;application/rdf+xml;image/svg+xml;image/gif;image/jpeg;image/png;image/x-bmp;image/x-xbm;application/mime
Comment=Web Browser
Type=Application
EOT
cd ../..

cat > opera-$VERSION/receipt <<EOT
PACKAGE="$PACKAGE"
VERSION="$VERSION"
CATEGORY="non-free"
SHORT_DESC="Opera Web browser."
DEPENDS="libQtGui"
WEB_SITE="http://www.opera.com/"
EOT

# Remove unwanted locale
mv opera-$VERSION/fs/usr/share/opera/locale opera-$VERSION/fs/usr/share/opera/locale-full
mkdir -p opera-$VERSION/fs/usr/share/opera/locale 
. /etc/locale.conf
for i in $LANG ${LANG/_/-} ${LANG:0:2} fr pt de zh-cn ; do
	[ -d opera-$VERSION/fs/usr/share/opera/locale-full/$i ] &&
	cp -a opera-$VERSION/fs/usr/share/opera/locale-full/$i \
		opera-$VERSION/fs/usr/share/opera/locale
done
rm -rf opera-$VERSION/fs/usr/share/opera/locale-full
rm -rf opera-$VERSION/fs/usr/share/pixmaps


# Pack
tazpkg pack opera-$VERSION

# Clean to save RAM memory
rm -rf opera-$VERSION

# Install pseudo package
tazpkg install opera-$VERSION.tazpkg --root=$ROOT
case " $@ " in
*\ --k*) mv opera-$VERSION.tazpkg $CUR_DIR ;;
esac

# Clean
cd $CUR_DIR
rm -rf $TMP_DIR

