#!/bin/sh

ppp="/usr/sbin/pppd local noauth nodetach"
port=1111
ipupd=/etc/ppp/ip-up.d

case "$0" in
*server) # Usage: pppnc-server [port] [localip:remoteip]
	n=10.$(($$%256)).$(($$/256))
	exec $ppp ${2:-$n.1:$n.2} passive proxyarp pty "nc -ulp ${1:-$port}"
esac

[ -z "$1" ] && echo "Usage: $0 serverip [port] [routes]" && exit 1
extra="$(route -n | awk -vd=$(nslookup ${1#*@} | sed '/::/d' | sed \
 '$!d;s/.*: \([^ ]*\).*/\1/') '$1=="0.0.0.0"{ print d " gw " $2 " dev " $8 }')"
for i in ${3/default/128.0.0.0/1 0.0.0.0/1} ; do
	echo "route add -net $i dev \$1"
done > $ipupd/pppnc$$
[ "$3" ] && echo "route add $extra" >> $ipupd/pppnc$$
chmod +x $ipupd/pppnc$$
$ppp noipdefault pty "nc -u $1 ${2:-$port}" ipparam pppnc$$
[ "$3" ] && route del $extra
rm -f $ipupd/pppnc$$
