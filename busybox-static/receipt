# SliTaz package receipt.

PACKAGE="busybox-static"
VERSION="1.17.3"
CATEGORY="base-system"
SHORT_DESC="Busybox combines tiny versions of many common UNIX utilities."
MAINTAINER="pascal.bellard@slitaz.org"
DEPENDS=""
BUILD_DEPENDS="bzip2 uclibc-cross-compiler-i486"
SOURCE="busybox"
TARBALL="$SOURCE-$VERSION.tar.bz2"
WEB_SITE="http://www.busybox.net/"
WGET_URL="http://www.busybox.net/downloads/$TARBALL"
CONFIG_FILES=""

# Rules to configure and make the package.
compile_rules()
{
    cd $src
    while read file; do
    	[ -f done.$file ] && continue
    	echo "Apply $file..."
    	patch -p1 < $WOK/$SOURCE/stuff/$SOURCE-$VERSION-$file || return 1
	touch done.$file
    done <<EOT
cpio-mkdir.u
tar.u
stat.u
ris.u
depmod.u
zmodules.u
usage.u
EOT
    cp ../stuff/$SOURCE-$VERSION.config .config
    make oldconfig
    if [ "$(gcc --version | awk '{ print $3; exit }')" == "4.5.0" ]; then
	# "CFLAGS=-O0" is a workaround for GCC 4.5.0 (sed crash)
	# "CFLAGS=-fno-tree-pta" may be a workaround for GCC 4.5.0 (sed garbage)
	make -j 4 "CFLAGS=-O0" && make "CFLAGS=-O0" install
    else
	make -j 4 && make install
    fi
    echo "Chmod 4755 on busybox binary..."
    chmod 4755 _install/bin/busybox
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
    mkdir -p $fs/usr/share/boot
    cp -a $src/_install/bin/busybox $fs/usr/share/boot/busybox-static
}
