# SliTaz package receipt.

PACKAGE="icedtea6-jdk"
SOURCE="icedtea6"
VERSION="1.9.1"
CATEGORY="development"
SHORT_DESC="A Free Software harness for OpenJDK."
MAINTAINER="rcx@zoominternet.net"
DEPENDS="icedtea6-jre glibc-base zlib xorg-libX11 xorg-libXau xorg-libXdmcp"
BUILD_DEPENDS="gcc+gcj slitaz-toolchain autoconf automake m4 diffutils gawk \
coreutils-file-special coreutils-file-summarize alsa-lib-dev cups-dev \
gawk file patch findutils perl zip unzip bzip2 tar cpio glib-dev zlib-dev \
fastjar rhino ecj apache-ant xalan-xerces-j \
freetype-dev gtk+-dev giflib-dev jpeg-dev libpng-dev \
xorg-inputproto xorg-kbproto xorg-libXi-dev xorg-libXinerama-dev \
xorg-libXp-dev xorg-libXt-dev xorg-libXtst-dev xorg-printproto \
xorg-recordproto xorg-renderproto xorg-xextproto xorg-xineramaproto xorg-xproto"
TARBALL="$SOURCE-$VERSION.tar.gz"
WEB_SITE="http://www.iced-tea.org/"
WGET_URL="http://icedtea.classpath.org/download/source/$TARBALL"

openjdk_version="b20"
openjdk_date="21_jun_2010"
JAXWS="jdk6-jaxws-${openjdk_version}.zip"
JAXP="jdk6-jaxp-${openjdk_version}.zip"
JAF="jdk6-jaf-${openjdk_version}.zip"
OPENJDK="openjdk-6-src-${openjdk_version}-${openjdk_date}.tar.gz"
WGETJAXWS="https://jax-ws.dev.java.net/files/documents/4202/150724"
WGETJAXP="https://jaxp.dev.java.net/files/documents/913/150648"
WGETJAF="https://jax-ws.dev.java.net/files/documents/4202/150725"
WGETOPENJDK="http://download.java.net/openjdk/jdk6/promoted/${openjdk_version}"

# Rules to configure and make the package.
compile_rules()
{
	# Limit memory usage
	ulimit -v $(awk '/MemTotal/ { print int(($2*80)/100) }' < /proc/meminfo)

	local JVM_PREFIX
	JVM_PREFIX="/usr/lib/jvm/java-icedtea"
	
	# NOTE: This build does not seem to work with ECJ 3.5
	local ECJ_VERSION
	ECJ_VERSION="3.6"

	cd $src
	mkdir drops
	sed -i -e 's/mkdir -p drops/true/' -e 's/ jar xf/ fastjar xf/'  Makefile*
	[ -L /usr/bin/wget ] && tazpkg get-install wget --forced
	for i in $JAXWS $JAXP $JAF ; do
		if [ -f $SOURCES_REPOSITORY/$i ]; then
			cp $SOURCES_REPOSITORY/$i drops
		elif [ "$i" == "$JAXWS" ]; then
			wget -O $SOURCES_REPOSITORY/$JAXWS --no-check-certificate "$WGETJAXWS/$JAXWS"
			cp $SOURCES_REPOSITORY/$JAXWS drops
		elif [ "$i" == "$JAXP" ]; then
			wget -O $SOURCES_REPOSITORY/$JAXP --no-check-certificate "$WGETJAXP/$JAXP"
			cp $SOURCES_REPOSITORY/$JAXP drops
		elif [ "$i" == "$JAF" ]; then
			wget -O $SOURCES_REPOSITORY/$JAF --no-check-certificate "$WGETJAF/$JAF"
			cp $SOURCES_REPOSITORY/$JAF drops
		fi
		
	done

	for i in $OPENJDK ; do
		if [ -f $SOURCES_REPOSITORY/$i ]; then
			cp $SOURCES_REPOSITORY/$i .
		else
			wget -O $SOURCES_REPOSITORY/$OPENJDK "$WGETOPENJDK/$OPENJDK"
			cp $SOURCES_REPOSITORY/$OPENJDK .
		fi
	done
	[ -L /usr/bin/find ] && tazpkg get-install findutils --forced
	[ -L /usr/bin/diff ] && tazpkg get-install diffutils --forced
	[ "$(readlink /usr/bin/awk)" == "gawk" ] ||
	tazpkg get-install gawk --forced
	[ -L /usr/bin/sed ] && tazpkg get-install sed --forced
	mem=$(free | awk '/Mem:/ { printf "%d\n",$2/1024 }')
	cat > slitaz.sh <<EOT
# Busybox compatibility
#find -name Sanity.gmk | xargs sed -i 's/--sync -kP/-k/' Makefile 
find -name Platform.gmk | xargs sed -i "s@MB_OF_MEMORY *:=.*free.*@MB_OF_MEMORY := $mem@" Makefile
EOT
	sed -i  -e 's|touch .*|&\n\tsh slitaz.sh|' \
		-e 's/--check/-c/' \
		-e 's/ln -sfv/ln -sf/' Makefile*
	autoreconf &&
	./configure \
		--prefix=/usr \
		--disable-plugin \
		--disable-docs \
		--with-ecj \
		--with-ecj-jar=/usr/share/java/ecj-$ECJ_VERSION.jar \
		--with-gcj \
		--with-gcj-home=/usr/lib/jvm/java-gcj \
		--with-xalan2-jar=/usr/share/java/xalan.jar \
		--with-xalan2-serializer-jar=/usr/share/java/serializer.jar \
		--with-xerces2-jar=/usr/share/java/xercesImpl.jar \
		--with-rhino=/usr/share/java/js.jar \
		--with-abs-install-dir=$JVM_PREFIX \
		$CONFIGURE_ARGS &&
	make -j 1 ARCH_PREFIX=  || return 1

	# NOTE: don't build with -j 4. Only build with -j 1 or tank will crash
	# NOTE: IcedTea6 does not define an "install" target
	
	rm -r -f $src/_pkg

	local JVM_BUILDDIR
	JVM_BUILDDIR=$src/openjdk.build/j2sdk-image
	local JVM_DESTDIR
	JVM_DESTDIR=$src/_pkg$JVM_PREFIX

	mkdir -p $JVM_DESTDIR
	cp -a $JVM_BUILDDIR/bin $JVM_DESTDIR
	cp -a $JVM_BUILDDIR/lib $JVM_DESTDIR
	
	mkdir -p $JVM_DESTDIR/jre
	cp -a $JVM_BUILDDIR/jre/bin $JVM_DESTDIR/jre
	cp -a $JVM_BUILDDIR/jre/lib $JVM_DESTDIR/jre
	
	# Delete duplicated executables from the JDK bin
	for jbin in $(ls -1 $JVM_DESTDIR/jre/bin) ; do
		rm -f $JVM_DESTDIR/bin/$jbin
	done

	# Create symlinks for JDK binaries
	mkdir -p $src/_pkg/usr/jdk-bin
	for jbin in $(ls -1 $JVM_DESTDIR/bin) ; do
		ln -s $JVM_PREFIX/bin/$jbin $src/_pkg/usr/jdk-bin/$jbin
	done
	
	# Create symlinks for JRE binaries
	mkdir -p $src/_pkg/usr/jre-bin
	for jbin in $(ls -1 $JVM_DESTDIR/jre/bin) ; do
		ln -s $JVM_PREFIX/jre/bin/$jbin $JVM_DESTDIR/bin/$jbin
		ln -s $JVM_PREFIX/jre/bin/$jbin $src/_pkg/usr/jre-bin
	done
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/lib/jvm/java-icedtea
	cp -a $_pkg/usr/lib/jvm/java-icedtea/bin $fs/usr/lib/jvm/java-icedtea
	cp -a $_pkg/usr/lib/jvm/java-icedtea/lib $fs/usr/lib/jvm/java-icedtea
}
