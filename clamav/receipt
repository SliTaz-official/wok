# SliTaz package receipt.

PACKAGE="clamav"
VERSION="0.96.1"
CATEGORY="security"
SHORT_DESC="Antivirus."
MAINTAINER="paul@slitaz.org"
DEPENDS="zlib gmp bzip2 slitaz-base-files ncurses"
BUILD_DEPENDS="zlib-dev gmp gmp-dev bzip2-dev ncurses-dev bash"
TARBALL="$PACKAGE-$VERSION.tar.gz"
WEB_SITE="http://www.clamav.net/"
WGET_URL="http://downloads.sourceforge.net/clamav/$TARBALL"
TAGS="antivirus"

# Rules to configure and make the package.
compile_rules()
{
	# Have to create clamav user/group to be able to compile
	adduser clamav -s /bin/false -h /tmp -H -D -S
	addgroup clamav

	cd $src
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc/clamav \
		--infodir=/usr/share/info \
		--mandir=/usr/share/man \
		--with-iconv=no \
		$CONFIGURE_ARGS &&
	make -j 4 &&
	make DESTDIR=$PWD/_pkg install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/lib $fs/usr/share $fs/etc/init.d 
	cp -a $_pkg/usr/bin $fs/usr
	cp -a $_pkg/usr/sbin $fs/usr
	cp -a $_pkg/etc $fs
	# Copy only shared lib (.so)
	cp -a $_pkg/usr/lib/*.so* $fs/usr/lib
	cp -a $_pkg/usr/share/clamav $fs/usr/share
	# Copy daemon from /stuff
	cp stuff/daemon-clamd $fs/etc/init.d/clamd
}

post_install()
{
	echo "Processing post-install commands..."
	
	# Enable freshclam update
	echo -n "Enabling freshclam update..."
	cd $1/etc/clamav
	sed -i 's/^Example/#Example/' freshclam.conf 
	status

	# Enable clamd configuration
	echo -n "Enabling clamd daemon..."
	cd $1/etc/clamav
	sed -i 's/^Example/#Example/; s/^#PidFile/PidFile/' clamd.conf
	status

	# Enable local socket
	echo -n "Enabling local socket..."
	cd $1/etc/clamav
	sed -i 's/^#LocalSocket /LocalSocket /' clamd.conf
	status

	# adduser clamav if needed
	if ! grep -q clamav $1/etc/passwd; then
		echo -n "Adding user clamav..."
		chroot $1/ adduser clamav -s /bin/false -H -D -S
		status
	fi

	# Enable daily.cvd updates (sometimes needed for new version)
	chown -R clamav:clamav /usr/share/clamav
}

# Del user clamav when pkg is removed.
post_remove()
{
	deluser clamav	
}

