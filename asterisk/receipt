# SliTaz package receipt.

PACKAGE="asterisk"
VERSION="bristuff"
CATEGORY="misc"
SHORT_DESC="Open Source PBX and telephony toolkit."
MAINTAINER="pascal.bellard@slitaz.org"
WEB_SITE="http://www.digium.com/"
WANTED="bristuff"
DEPENDS="openssl ncurses zlib libogg libvorbis curl newt libusb alsa-lib \
speex iksemel spandsp tiff radiusclient-ng nbs freetds libpostgresqlclient \
libmysqlclient"
CONFIG_FILES="/etc/asterisk"

# Extract VERSION from WANTED package source
get_version()
{
	eval $(grep ^AST_VER= $WOK/$WANTED/$WANTED-*/download.sh)
	VERSION=$WANTED-$AST_VER
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	get_version
	[ -d taz/$PACKAGE-$WANTED/fs ] && \
		mv taz/$PACKAGE-$WANTED taz/$PACKAGE-$VERSION
	_pkg=$(cd $(dirname $src)/$WANTED-*/_pkg ; pwd)
	while read file; do
		dir=$(dirname $file)
		[ -d $fs$dir ] || mkdir -p $fs$dir
		eval cp -a "$_pkg$file" $fs$dir
	done < $_pkg/../$PACKAGE.files-list
	for i in $fs/etc/asterisk/*.sample; do
		mv $i ${i%.sample}
	done
	cp -a stuff/* $fs
}

# Rules to configure package
setup_rules()
{
	case "$2" in
	mysql_host)
		sed -i "s|^hostname=.*|hostname=$3|" $1/etc/asterisk/cdr_mysql.conf
		sed -i "s|^dbhost=.*|dbhost=$3|" $1/etc/asterisk/res_mysql.conf
		;;
	mysql_user)
		sed -i "s|^user=.*|user=$3|" $1/etc/asterisk/cdr_mysql.conf
		sed -i "s|^dbuser=.*|dbuser=$3|" $1/etc/asterisk/res_mysql.conf
		;;
	mysql_password)
		sed -i "s|^password=.*|password=$3|" $1/etc/asterisk/cdr_mysql.conf
		sed -i "s|^dbpass=.*|dbpass=$3|" $1/etc/asterisk/res_mysql.conf
		;;
	mysql_database)
		sed -i "s|^dbname=.*|dbname=$3|" $1/etc/asterisk/res_mysql.conf \
						 $1/etc/asterisk/cdr_mysql.conf
		;;
	pgsql_host)
		sed -i "s|^hostname=.*|hostname=$3|" $1/etc/asterisk/cdr_pgsql.conf
		sed -i "s|^dbhost=.*|dbhost=$3|" $1/etc/asterisk/res_pgsql.conf
		;;
	pgsql_user)
		sed -i "s|^user=.*|user=$3|" $1/etc/asterisk/cdr_pgsql.conf
		sed -i "s|^dbuser=.*|dbuser=$3|" $1/etc/asterisk/res_pgsql.conf
		;;
	pgsql_password)
		sed -i "s|^password=.*|password=$3|" $1/etc/asterisk/cdr_pgsql.conf
		sed -i "s|^dbpass=.*|dbpass=$3|" $1/etc/asterisk/res_pgsql.conf
		;;
	pgsql_database)
		sed -i "s|^dbname=.*|dbname=$3|" $1/etc/asterisk/res_pgsql.conf \
						 $1/etc/asterisk/cdr_pgsql.conf
		;;
	*)	cat <<EOT
mysql_host	hostname or ip of mysql server
mysql_user	username to connect to mysql server
mysql_password	password to connect to mysql server
mysql_database	database used by asterisk
pgsql_host	hostname or ip of postgresql server
pgsql_user	username to connect to postgresql server
pgsql_password	password to connect to postgresql server
pgsql_database	database used by asterisk
EOT
		;;
	esac
}
