# SliTaz package receipt.

PACKAGE="busybox-pam"
VERSION="1.12.0"
CATEGORY="base-system"
SHORT_DESC="Busybox combines tiny versions of many common UNIX utilities."
MAINTAINER="pascal.bellard@slitaz.org"
DEPENDS="slitaz-base-files glibc-base pam"
BUILD_DEPENDS="bzip2 pam pam-dev"
SOURCE="busybox"
TARBALL="$SOURCE-$VERSION.tar.bz2"
WEB_SITE="http://www.busybox.net/"
WGET_URL="http://www.busybox.net/downloads/$TARBALL"
CONFIG_FILES="/etc/dnsd.conf /etc/inetd.conf /etc/udhcpd.conf /etc/resolv.conf"
PROVIDE="busybox:pam"

# Rules to configure and make the package.
compile_rules()
{
    cd $src
    while read file; do
    	[ -f done.$file ] && continue
    	echo "Apply $file..."
    	patch -p1 < $WOK/$SOURCE/stuff/$SOURCE-$VERSION-$file || return 1
	touch done.$file
    done <<EOT
vcsa2txt.u
dhcpc.u
cpio-mkdir.u
tar.u
stat.u
zmodules.u
modinfo.u
modprobe.u
paths.u
mkswap.u
install.u
basename.u
unlzma.u
replay.u
ris.u
dpkg_deb.u
ionice.u
syslogd.u
iptunnel.u
rpm2cpio.u
EOT
    cp $WOK/$SOURCE/stuff/$SOURCE-$VERSION.config .config
    sed -i 's/# CONFIG_PAM is not set/CONFIG_PAM=y/' .config
    make oldconfig
    make && make install
    echo "Chmod 4755 on busybox binary..."
    chmod 4755 _install/bin/busybox
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
    cp -a $src/_install/* $fs
    rm -f $fs/sbin/depmod $fs/usr/bin/ar
    cp -a stuff/etc $fs
    mkdir -p $fs/etc/init.d
    # Busybox config files.
    # genpkg busybox-pam depends on busybox config files
    # Note: no space/tab before WANTED
WANTED="busybox"
    cd $WOK/$SOURCE
    fs=$WOK/$PACKAGE/taz/$PACKAGE-$VERSION/fs
    cp stuff/busybox.conf $fs/etc
    chmod 600 $fs/etc/busybox.conf
    cp stuff/dnsd.conf $fs/etc
    cp stuff/udhcpd.conf $fs/etc
    touch $fs/etc/resolv.conf
    cp stuff/inetd.conf $fs/etc
    cp stuff/dnsd $fs/etc/init.d
    cp stuff/udhcpd $fs/etc/init.d
    cp stuff/inetd $fs/etc/init.d
    cp stuff/zcip $fs/etc/init.d
    cp stuff/init $fs
    rm $fs/linuxrc
    mkdir -p $fs/etc/modprobe.d
    # Udhcpc stuff.
    mkdir -p $fs/usr/share/udhcpc
    cp stuff/udhcp.script \
    $fs/usr/share/udhcpc/default.script
    chmod +x $fs/usr/share/udhcpc/default.script
    # ZeroConf stuff.
    cp stuff/zcip.script $fs/etc
    # .desktop stuff
    mkdir -p $fs/usr/share
    cp -a stuff/applications $fs/usr/share
}

# Force glibc-2.7 reinstall if 2.3.6 still in use.
pre_install()
{
	local i
	cp -a /etc/resolv.conf /etc/resolv.conf-busybox-install
	if grep -q 'VERSION="2.3.6"' /var/lib/tazpkg/installed/glibc-base/receipt; then
		tazpkg get-install glibc-base --forced
	fi
	answer=""
	while read i ; do
		[ -e $ROOT$i ] || continue
		if [ -z "$answer" ]; then
			echo -n "Keep installed GNU utilities ? "
			read answer
			case "$answer" in
			y*|Y*|o*|O*);;
			*) break;;
			esac
		fi
		mv $ROOT$i $ROOT$i-busybox-install
	done < $1$INSTALLED/$PACKAGE/files.list
}

post_install()
{
	local i
	mv -f /etc/resolv.conf-busybox-install /etc/resolv.conf
	while read i ; do
		[ -e $ROOT$i-busybox-install ] || continue
		mv $ROOT$i-busybox-install $ROOT$i
	done < $1$INSTALLED/$PACKAGE/files.list
}
