# SliTaz package receipt.

PACKAGE="busybox-boot"
VERSION="1.21.0"
CATEGORY="base-system"
SHORT_DESC="Many common UNIX utilities for core-5in1/boot flavor."
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL2"
DEPENDS="linux syslinux"
WANTED="busybox"
WEB_SITE="http://www.busybox.net/"
CONFIG_FILES=""

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	jslinux=false
	mkdir -p $fs/usr/share/boot/bin $fs/usr/share/boot/dev
	CHOICE=static
	for i in uclibc musl diet ; do
		[ -x $src/busybox-$i ] || continue
		[ $(stat -c %s $src/busybox-$i) -lt \
	          $(stat -c %s $src/busybox-$CHOICE) ] &&
		CHOICE=$i
	done
	cp -a $src/busybox-$CHOICE $fs/usr/share/boot/bin/busybox
	chmod 4755 $fs/usr/share/boot/bin/busybox
	mknod -m 660 $fs/usr/share/boot/dev/console c 5 1
	mknod -m 771 $fs/usr/share/boot/dev/null c 1 3
	mknod -m 660 $fs/usr/share/boot/dev/tty c 5 0
	mknod -m 660 $fs/usr/share/boot/dev/tty1 c 4 1
	if $jslinux; then
		mknod -m 644 $fs/usr/share/boot/dev/clipboard c 10 231
		mknod -m 660 $fs/usr/share/boot/dev/ttyS0 c 4 64
	fi
	cat > $fs/usr/share/boot/init <<EOT
#!/bin/busybox sh

for i in \$(busybox --list) ; do busybox ln /bin/busybox /bin/\$i; done

export PATH=/bin
export HOME=/
export TERM=vt100

mkdir /tmp /mnt /proc
mount -t proc none /proc
while read name major minor ; do
	for i in '' 1 2 3 4 5 6 7 8 9 ; do
		mknod -m 644 /dev/\$name\$i b \$major \$((\$i + \$minor))
	done
done <<EOM
loop	7	0
hda	3	0
hdb	3	64
sda	8	0
sdb	8	16
EOM

arg()
{
grep -q \$1= /proc/cmdline && root="\$(sed "s/.*\$1=\\([^ ]*\\).*/\\1/" </proc/cmdline)"
}

arg mount && mount \$root /mnt
arg loopfs && losetup /dev/loop /mnt/\$root && mount /dev/loop /mnt
arg subroot && cp /bin/busybox /mnt/\$root/dev/shm &&
exec switch_root mnt \$root/dev/shm/busybox chroot \$root /sbin/init
arg loopfs && exec switch_root mnt /sbin/init

[ -d /proc/bus/usb ] && mount -t usbfs usbfs /proc/bus/usb
while read type dir ; do
	grep -qs \$type /proc/filesystems &&
	mkdir \$dir && mount -t \$type none \$dir
done <<EOM
sysfs	/sys
devpts	/dev/pts
EOM

TTY=\$(tty 2>/dev/null)
TTY=\${TTY:-/dev/tty1}
EOT
	$jslinux && echo 'stty -F $TTY rows 30 2>/dev/null' >> $fs/usr/share/boot/init
	cat >> $fs/usr/share/boot/init <<EOT

busybox | sed '/Current/,\$!d'
while true; do
	if [ -x /bin/setsid ]; then
		setsid sh -c "exec sh <\$TTY >\$TTY 2>&1"
	else
		sh <\$TTY >\$TTY 2>&1
	fi
done
EOT
	chmod +x $fs/usr/share/boot/init
	( cd $fs/usr/share/boot ; find bin dev init | cpio -o -H newc > initrd )
	rm -rf $fs/usr/share/boot/bin $fs/usr/share/boot/dev $fs/usr/share/boot/init
}
