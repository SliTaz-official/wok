#!/bin/sh
# SliTaz package receipt.

PACKAGE="bristuff"
VERSION="0.4.0-test6-xr1"
CATEGORY="meta"
SHORT_DESC="ISDN patches for Asterisk/Zaptel."
MAINTAINER="pascal.bellard@slitaz.org"
TARBALL="$PACKAGE-$VERSION.tar.gz"
WEB_SITE="http://www.junghanns.net/"
WGET_URL="http://updates.xorcom.com/astribank/bristuff/1.4/$TARBALL"
BUILD_DEPENDS="openssl-dev ncurses-dev zlib-dev patch libogg-dev libvorbis-dev \
curl-dev newt-dev libusb-dev sqlite-dev alsa-lib-dev fxload speex-dev \
iksemel-dev mysql-dev glibc-dev spandsp-dev tiff-dev radiusclient-ng-dev \
mysql libmysqlclient cmake postgresql postgresql-dev libpostgresqlclient \
libtool unixODBC-dev libunixODBC"
DEPENDS="asterisk asterisk-sound zaptel mISDNuser"

#TODO: net-snmp(-dev) vpb-driver(-dev)
#Asterisk: libopenh323-dev (Not so nice addon), libsnmp-dev (Asterisk 1.4)
#Asterisk+=app_ivrdemo? app_osplookup app_rpt? app_skel?
#Asterisk+=cdr_sqlite(sqlite) res_snmp(netsnmp)
#Asterisk+=chan_features? chan_h323(openh323) chan_vpb(vpbapi)
#Asterisk+=pbx_gtkconsole(gtk) pbx_kdeconsole(qt)
#Asterisk+=IMAP_STORAGE(imap_tk,ssl) CORE-SOUNDS-ES-GSM CORE-SOUNDS-FR-GSM
#Asterisk+=MOH-FREEPLAY-GSM EXTRA-SOUNDS-EN-GSM

# Download a source tarball
. /etc/tazwok.conf
slitaz_wget()
{
	if [ ! -f $SOURCES_REPOSITORY/$(basename $2) ]; then
		local here=$(pwd)
		cd $SOURCES_REPOSITORY
		wget $1 $2
		cd $here
	fi
	cp $SOURCES_REPOSITORY/$(basename $2) .
}

# Rules to configure and make the package.
compile_rules()
{
	if [ ! -d ../linux/taz ]; then
		tazwok cook linux
	fi
	KVERS=$(grep "kernel version" ../linux/linux-*/.config)
	KVERS=${KVERS##* }
	KSRC=$(cd ../linux/linux-* ; pwd)
	export KVERS
	export KSRC
	cd $src
	eval $(grep ^ADD_VER= download.sh)
	slitaz_wget -c $SF_MIRROR/agx-ast-addons/agx-ast-addons-$ADD_VER.tar.bz2
	#bluetooth:
	#slitaz_wget -c http://svn.digium.com/view/asterisk-addons/trunk/channels/chan_mobile.c?view=co
	#slitaz_wget -c http://www.chan-mobile.org/downloads/chan_mobile-1.4.x.patch
	# cd asterisk-addons
	# patch -p0 < chan_mobile-1.4.x.patch
	tar xjf agx-ast-addons-$ADD_VER.tar.bz2
	for i in CMakeLists.u bristuff.u; do
		[ -f done.$i ] && continue
		patch -p0 < ../stuff/$i || return 1
		touch done.$i
	done
	chmod +x apply-patches.sh
	sh ./download.sh
	for i in sounds.u; do
		[ -f done.$i ] && continue
		patch -p0 < ../stuff/$i || return 1
		touch done.$i
	done
	ln -s . zaptel/zaptel
	ln -s . zaptel/linux
	mkdir -p _pkg/etc/init.d _pkg/usr/include/zaptel
	[ -f done.uname ] ||
	grep -rsl "uname -r" . | xargs sed -i -e "s/uname -r/echo $KVERS/g"
	touch done.uname
	export BRISTUFF_ZAP_PARAMS="KBUILD_NOPEDANTIC=1"
	sh ./compile.sh -d $(cd _pkg; pwd) -i
	cp asterisk/configs/* _pkg/etc/asterisk/
	cd agx-ast-addons
	cmake "." -DCMAKE_INSTALL_PREFIX=../_pkg/usr
	make install
	cd ..
	ln -s libgsmat.so.1.0 _pkg/usr/lib/libgsmat.so.1
	cp ../stuff/*.files-list .
}


# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	# Just to have a dir.
	mkdir -p $fs/var/lib/asterisk
	# Cook all packages based on bristuff
	for i in $(cd $WOK; grep -l '^WANTED="bristuff"$' */receipt)
	do
		tazwok cook ${i%/receipt}
	done
}

