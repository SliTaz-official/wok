# SliTaz package receipt.

PACKAGE="squashfs"
VERSION="3.3"
CATEGORY="base-system"
SHORT_DESC="Linux squashfs module and userland tools."
MAINTAINER="pascal.bellard@slitaz.org"
WEB_SITE="http://$PACKAGE.sourceforge.net/"
TARBALL="squashfs$VERSION.tgz"
WGET_URL="$SF_MIRROR/$PACKAGE/$TARBALL"
DEPENDS="zlib"
BUILD_DEPENDS="zlib-dev patch"

# Rules to configure and make the package.
compile_rules()
{
	local kver
	local patch_dir

	# get kernel version
	if [ ! -d ../linux/taz ]; then
		tazwok cook linux
	fi
	kver=$(grep "kernel version" ../linux/linux-*/.config)
	kver=${kver##* }

	# Select patch according to kernel version
	patch_dir=${PACKAGE}${VERSION}/kernel-patches/linux-${kver%.*}
	if [ -f ${PACKAGE}${VERSION}/kernel-patches/linux-$kver ]; then
		patch_dir=${PACKAGE}${VERSION}/kernel-patches/linux-$kver
	fi
	if [ ! -d $patch_dir ]; then
		echo "No squashfs patchset for kernel $ker. Abort."
		return 1
	fi
	[ -d _kernel ] && rm -rf _kernel
	mkdir _kernel
	cd _kernel
	ln -s ../../linux/linux-$kver* src

	# Copy files to be patched in local aera
	# Do not alter kernel sources !!
	for i in $(grep ^--- ../$patch_dir/${PACKAGE}${VERSION}-patch | \
    		awk '{ if ($3 != "1970-01-01") print $2 } '); do
		( cd src ; tar cf - ${i#*/}) | tar xf -
	done

	# Apply squashfs patches in local aera
	patch -p1 < ../$patch_dir/${PACKAGE}${VERSION}-patch

	# Move every files in fs/squashfs directory
	mv include/linux/* fs/squashfs
	ln -s . fs/squashfs/linux
	for i in fs/squashfs/*.c fs/squashfs/*.h ; do
		sed -e 's/#include <\(linux\/squashfs.*\)>.*/#include "\1"/g' > $i.$$ < $i
		sed -e 's/CONFIG_SQUASHFS_FRAGMENT_CACHE_SIZE/3/g' > $i < $i.$$
	done
	
	# Build kernel module
	make -C src/. SUBDIRS=$(pwd)/fs/squashfs/ CONFIG_SQUASHFS=m modules
	cd ..
	[ -d _pkg ] && rm -rf _pkg
	mkdir -p _pkg/lib/modules/$kver-slitaz/kernel/fs/squashfs
	mkdir -p _pkg/usr/sbin _pkg/sbin
	cp _kernel/fs/squashfs/squashfs.ko \
        	_pkg/lib/modules/$kver-slitaz/kernel/fs/squashfs/squashfs.ko
	gzip -9 _pkg/lib/modules/$kver-slitaz/kernel/fs/squashfs/squashfs.ko

	# Build user land tools
	cd ${PACKAGE}${VERSION}/squashfs-tools
	make
	cp mksquashfs ../../_pkg/usr/sbin
	cp unsquashfs ../../_pkg/sbin
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	cp -a _pkg/* $fs
}

# Post install/remove commands for Tazpkg.
post_install()
{
	depmod -a -b "$(dirname $1/lib/modules/*/modules.dep)"
}

post_remove()
{
	depmod -a
}
