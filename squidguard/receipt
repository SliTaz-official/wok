# SliTaz package receipt.

PACKAGE="squidguard"
VERSION="1.3"
CATEGORY="network"
SHORT_DESC="Web filter."
MAINTAINER="pascal.bellard@slitaz.org"
SOURCE="squidGuard"
TARBALL="$SOURCE-$VERSION.tar.gz"
WEB_SITE="http://www.squidguard.org/"
WGET_URL="${WEB_SITE}Downloads/$TARBALL"
DEPENDS="squid libdb"
BUILD_DEPENDS="db-dev"

# Rules to configure and make the package.
compile_rules()
{
	cd $src
	./configure --prefix=/usr --infodir=/usr/share/info \
	--sysconfdir=/etc --with-sg-config=/etc/squid/squidGuard.conf \
	--with-sg-logdir=/var/lib/squidGuard/log \
	--with-sg-dbhome=/var/lib/squidGuard/db \
	--mandir=/usr/share/man $CONFIGURE_ARGS
	make
	sed -e 's|^prefix =.*|prefix = _pkg/usr|' \
	    -e 's|^logdir =.*|logdir = _pkg/var/lib/squidGuard/log|' \
	    -e 's|^configfile =.*|configfile = _pkg/etc/squid/squidGuard.conf|' \
	    -e 's|^dbhomedir =.*|dbhomedir = _pkg/var/lib/squidGuard/db|' \
	    -e 's|^SQUIDUSER =.*|SQUIDUSER = root|' \
	    < Makefile > Makefile.slitaz-install
	mkdir -p _pkg/etc/squid
	make -f Makefile.slitaz-install install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	cp -a $_pkg/* $fs/
}

# Pre and post install commands for Tazpkg.
post_install()
{
	chown -R nobody /var/lib/squidGuard/* /usr/squidGuard
	if ! grep ^redirect_program $1/etc/squid/squid.conf ; then
		echo "Updating /etc/squid/squid.conf"
		cat >> $1/etc/squid/squid.conf <<EOF
redirect_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf
EOF
	fi
}
