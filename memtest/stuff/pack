#!/bin/sh
if [ "$1" == "--build" ]; then
	bin=${2:-unpack.bin}
	cat >> $0 <<EOM
$(gzip -9 < $bin | uuencode -m -)
EOT
EOM
	getip=$(grep -s getip ${bin/.bin/.lst}|sed '$!d;s/.*t:\([^ ]*\).*/\1/')
	sed -i "s/XXX/$((515+0x${getip:-5}))/" $0
	sed -i '/--build/,/^fi/d' $0
	exit
fi

store()
{
	n=$1
	for i in $(seq 1 $4); do
		printf '\\\\x%02X' $(($n & 255))
		n=$(($n >> 8))
	done | xargs echo -en | dd conv=notrunc bs=1 of=$2 seek=$3
}

compress()
{
	xz -z -e --format=lzma --lzma1=mode=normal --stdout
}

main()
{
	dd if=$1 bs=512 count=1 >$2
	uudecode | gunzip >>$2
	setup="$(echo $(od -j 497 -N 1 -dAn $1))"
	syssize="$(echo $(od -j 500 -N 2 -dAn $1))"
	dd if=$1 bs=512 count=$setup skip=1 | compress >>$2
	dd if=$1 bs=16 count=$syssize skip=$((32*(1+$setup))) | compress >>$2
	size=$(stat -c %s $2)
	store $((($size-512)/16)) $2 XXX 2
	store $((($size-2560)/16)) $2 500 2
	store 4 $2 497 1
}

main $1 $2 2>/dev/null <<EOT
