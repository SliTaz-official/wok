#!/bin/sh

[ -s "$1" -a "$2" ] || {
	cat << EOT
Usage: $0 zImage-to-read bzImage-to-create [version-string]
EOT
	exit 1
}

ddq()
{
	dd "$@" 2> /dev/null
}

get()
{
	echo $( od -v -j $(($1)) -N ${4:-${3:-2}} -t u${3:-2} -w${3:-2} \
		-An $2 2>/dev/null )
}

store()
{
	n=$3; for i in $(seq 8 8 $1); do
		printf '\\\\x%02X' $(($n & 255))
		n=$(($n >> 8))
	done | xargs echo -en | ddq bs=1 conv=notrunc of=$4 seek=$(($2))
}

create_bzImage()
{
	ddq bs=512 count=1 of=$1
	# from http://hg.slitaz.org/wok/file/7184ec55b1aa/linux/stuff/linux-header.u
	uudecode <<EOT | ddq of=$1 conv=notrunc
begin-base64 644 -
TVrrIEAAAAACAAAQ//8ACASeAABfAvD/TmV4dCEHDQA/owCeUuiwAZkfoPF9
QA+hxXd4XwZXsQbzpRYfZGaPR3jGRfg/+pdYQejIAL4AAoFMECCAxkQlm+hv
AVuJ5v9IEMdAFAiTgPMIdfOhFQJmix70AWZLZsHrBWZDvwAQOcd1AzWAFolE
G2a/gAAAAGYp+5xzAgHfUFZTMdtoAIAH6GEAW16MwbSHFgfNFVgFAAEQTB+/
gAedd8WITB/GRBwQx0QTgAa0h80Vl80T6gAAIJBaOMF3NGDNE/noeABhUlAo
yHcCsAE5+HICifhQtALNE1pYctyVAdGO6QDXANcp11p0UozplTjBddSIyLEB
MM51zP7FgP1QdcW1AGC+GABT6KoAW+g+AHUVUpjNE7gBAs0TWtDUOmT+depG
SHXm650x0ugAAAYftD+J+cHhCInrzSGSFh+wMRwDtA67BwDNEDwNdPPDv2wE
ZMYFprgNAWQ6JXQKzRZ09JjNFo7nR8PoVgCg0QJAvoAAigxG86SXgHz/P77g
AnQyDwHgJAF1K45fLEM5D3X7jVcEtD3NIXInleiM/4AGoAA9uwICOV8EcgXH
RyeeCR5qTMsDdA6wDeiH/6w8AH/4w16/xp1oAJAXifwWBzHAuTsA86pPW1bD
AA==
====
EOT
	# from tobzimage.S
	uudecode <<EOT | gunzip >> $1
begin-base64 644 -
H4sIACpPrlUCA3ut4pFSFMzAxAACAg0MDIwMQEKAARXM+cOXxZAgx76vhsnw
P1v40qX7GZg6n+7kZMhiePRnB+PkmQGBQYELxJiA1EYOkFh36JfOZzsZGra0
nxX97yLy30Wm4Z1A+ZvON/sYWAxP/vP92JX78fTnpYnnqzxzE9NTFQz0DBlG
wQAAAJkasY8AAgAA
====
EOT
	if [ "$2" ]; then
		s="$2"
		[ -s "$2" ] && s="$(cat "$2")"
		echo -e "\n$2" | tr '\n' '\r' | cat - /dev/zero | \
		dd conv=notrunc of=$1 bs=1 seek=640 count=383
	fi
	setupsz=$(get 497 $1 1)
	[ $setupsz -eq 0 ] && setupsz=4
	ddq bs=512 count=$setupsz >> $1
	store 8 497 $(($setupsz+1)) $1
	ddq >> $1
}

create_bzImage $2 "$3" < $1
