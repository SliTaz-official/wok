# SliTaz package receipt.

PACKAGE="mesa"
VERSION="7.9"
CATEGORY="x-window"
SHORT_DESC="3D Graphics Library that is an open-source implementaton of OpenGL."
MAINTAINER="pascal.bellard@slitaz.org"
DEPENDS="glibc-base expat libdrm xorg-libX11 xorg-libXau xorg-libXdamage \
xorg-libXdmcp xorg-libXext xorg-libXfixes xorg-libXxf86vm libxcb talloc"
SUGGESTED="nvidia"
BUILD_DEPENDS="$DEPENDS slitaz-toolchain expat-dev lesstif lesstif-dev libdrm-dev \
xorg-dri2proto xorg-glproto xorg-damageproto xorg-xproto xorg-fixesproto xorg-xextproto \
xorg-libX11-dev xorg-libXdamage-dev xorg-libXfixes-dev xorg-libXt-dev \
xorg-libICE-dev xorg-libSM-dev xorg-xf86vidmodeproto xorg-libXxf86vm-dev pkg-config
wget talloc-dev libxml2-python libxcb-dev"
SOURCE="Mesa"
TARBALL="${SOURCE}Lib-$VERSION.tar.bz2"
WEB_SITE="http://www.mesa3d.org/"
WGET_URL="ftp://ftp.freedesktop.org/pub/mesa/$VERSION/$TARBALL"
PROVIDE="libgl"

# Rules to configure and make the package.
compile_rules()
{
	ln -s $src $PACKAGE-$VERSION 2>/dev/null

	cd $src
	# --with-dri-driverdir=/usr/lib/X11/modules/dri ?
	sed 's@FLAGS=\"-g@FLAGS=\"@' -i configure &&
	./configure \
		--prefix=/usr \
		--with-x \
		--enable-gl-osmesa \
		--enable-motif \
		--enable-gallium-radeon \
		--enable-gallium-nouveau \
		--enable-xcb \
		$CONFIGURE_ARGS &&
	# Also build nouveau_vieux_dri.so.
	make -j 4 &&
	make -j 4 -C src/mesa/drivers/dri/nouveau &&
	make DESTDIR=$PWD/_pkg install &&
	make -C src/mesa/drivers/dri/nouveau DESTDIR=$PWD/_pkg install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/lib
	cp -a $_pkg/usr/lib/*.so* $fs/usr/lib

	# DRI drivers are include in the package mesa-dri-*
	#cp -a $_pkg/usr/lib/dri $fs/usr/lib

	# libGLU is included in the package libglu-mesa
	rm -r -f $fs/usr/lib/libGLU*

	#libGLw is included in the package libglw-mesa
	rm -r -f $fs/usr/lib/libGLw*
	
	#libEGL is included in the package libegl-mesa
	rm -r -f $fs/usr/lib/libEGL*
}
